<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asset Manager Pro - Complete Rewrite</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      scroll-behavior: smooth;
    }
    
    html:not(.dark) {
      background-color: #f8fafc;
      color: #0f172a;
    }
    
    html.dark {
      background-color: #0d1117;
      color: #e6edf3;
    }
    
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.2s ease, color 0.2s ease;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    html.dark ::-webkit-scrollbar-thumb { background: #30363d; }

    .hidden { display: none !important; }

    /* AUTH SCREEN */
    #authScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%; height: 100%;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      padding: 2rem 1rem;
      overflow-y: auto;
    }

    #authScreen.hidden { display: none !important; }

    .auth-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      padding: 2.5rem;
      max-width: 480px;
      width: 100%;
      animation: slideInUp 0.4s ease;
    }

    html.dark .auth-card { background: #161b22; }

    @keyframes slideInUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .auth-title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 2rem;
    }

    .auth-title h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .auth-title p {
      color: #64748b;
      font-size: 0.875rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem 0.875rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: white;
      color: #0f172a;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    html.dark input,
    html.dark select,
    html.dark textarea {
      background: #0d1117;
      border-color: #30363d;
      color: #c9d1d9;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
      width: 100%;
      margin-top: 1rem;
    }

    .btn-primary:hover { background: #1d4ed8; }
    .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }

    .btn-secondary { background: #64748b; color: white; }
    .btn-secondary:hover { background: #475569; }

    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }

    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; width: auto; }
    .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; }

    /* MAIN SCREEN */
    #mainScreen {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #mainScreen.hidden { display: none !important; }

    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e2e8f0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    html.dark .sidebar {
      background: #0f172a;
      border-right-color: #1e293b;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    html.dark .sidebar-header { border-bottom-color: #1e293b; }

    .sidebar-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sidebar-menu {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
    }

    .sidebar-menu-item {
      padding: 0.875rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .sidebar-menu-item:hover { background: #f1f5f9; }
    html.dark .sidebar-menu-item:hover { background: #1e293b; }

    .sidebar-menu-item.active {
      background: #f1f5f9;
      border-left-color: #2563eb;
      font-weight: 600;
    }

    html.dark .sidebar-menu-item.active { background: #1e293b; }

    .sidebar-menu-item-title { font-size: 0.875rem; margin-bottom: 0.25rem; }
    .sidebar-menu-item-subtitle { font-size: 0.75rem; color: #64748b; }

    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 0.5rem;
    }

    html.dark .sidebar-footer { border-top-color: #1e293b; }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-bar {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    html.dark .top-bar {
      background: #0f172a;
      border-bottom-color: #1e293b;
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .header {
      margin-bottom: 2rem;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .header-subtitle {
      color: #64748b;
      font-size: 0.875rem;
    }

    /* TABLES */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    html.dark table { background: #161b22; }

    thead { background: #f8fafc; }
    html.dark thead { background: #0f172a; }

    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #64748b;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.875rem;
    }

    html.dark th { border-bottom-color: #30363d; }

    td {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    html.dark td { border-bottom-color: #30363d; }

    tbody tr:hover { background: #f8fafc; }
    html.dark tbody tr:hover { background: #0f172a; }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-green { background: #dcfce7; color: #166534; }
    .badge-orange { background: #fed7aa; color: #92400e; }
    .badge-red { background: #fecaca; color: #991b1b; }

    /* MODALS */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%; height: 100%;
      z-index: 99998;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
    }

    .modal.active { display: flex !important; }

    .modal-content {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      padding: 2rem;
      max-width: 640px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideInUp 0.3s ease;
    }

    html.dark .modal-content { background: #161b22; }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    html.dark .modal-header { border-bottom-color: #30363d; }

    .modal-title { font-size: 1.25rem; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    .modal-close:hover { color: #0f172a; }

    .modal-body { margin-bottom: 1.5rem; }
    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .notify-recipient {
      background: #dbeafe;
      border-left: 4px solid #0284c7;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #0c4a6e;
      font-weight: 500;
      border-radius: 0.5rem;
    }

    html.dark .notify-recipient {
      background: #082f49;
      color: #e0f2fe;
    }

    .search-box { flex: 1; max-width: 300px; }
    .search-box input { width: 100%; }

    .actions { display: flex; gap: 0.5rem; }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="hidden">
  <div class="auth-card">
    <div class="auth-title">
      <div class="logo-icon">üì¶</div>
      <h1>Asset Manager Pro</h1>
      <p>Professional Inventory System</p>
    </div>

    <div id="setupForm" class="hidden">
      <div style="background: #dbeafe; color: #0c4a6e; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem; border: 1px solid #7dd3fc; font-size: 0.875rem;">
        üîß First Time Setup - You will be the admin
      </div>
      <form onsubmit="registerAdmin(event)">
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="setupName" placeholder="Your name" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="setupEmail" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label>Mobile</label>
          <input type="tel" id="setupMobile" placeholder="+1234567890">
        </div>
        <div class="form-group">
          <label>Designation</label>
          <input type="text" id="setupDesignation" placeholder="e.g., Manager">
        </div>
        <div class="form-group">
          <label>Department</label>
          <input type="text" id="setupDepartment" placeholder="e.g., Operations">
        </div>
        <div class="form-group">
          <label>Password * (Min 6)</label>
          <input type="password" id="setupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
        </div>
        <div class="form-group">
          <label>Confirm Password *</label>
          <input type="password" id="setupConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn btn-primary">üëë Create Admin Account</button>
      </form>
      <p style="margin-top: 1rem; text-align: center; color: #64748b; font-size: 0.875rem;">
        Already registered? <a href="#" onclick="showLogin()" style="color: #2563eb; cursor: pointer; text-decoration: none;">Sign In</a>
      </p>
    </div>

    <div id="loginForm">
      <form onsubmit="login(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn btn-primary">üîì Sign In</button>
      </form>
      <p style="margin-top: 1rem; text-align: center; color: #64748b; font-size: 0.875rem;">New user? Ask your admin to add you.</p>
    </div>
  </div>
</div>

<!-- MAIN SCREEN -->
<div id="mainScreen">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>üìã Menu</h2>
    </div>
    <div class="sidebar-menu">
      <div class="sidebar-menu-item active" onclick="showSection('items')">
        <div class="sidebar-menu-item-title">üì¶</div>
        <div class="sidebar-menu-item-title">View Items</div>
        <div class="sidebar-menu-item-subtitle">Browse all items</div>
      </div>
      <div class="sidebar-menu-item" onclick="showSection('addItem')">
        <div class="sidebar-menu-item-title">‚ûï</div>
        <div class="sidebar-menu-item-title">Add Item</div>
        <div class="sidebar-menu-item-subtitle">Create new</div>
      </div>
      <div class="sidebar-menu-item" onclick="showSection('members')">
        <div class="sidebar-menu-item-title">üë•</div>
        <div class="sidebar-menu-item-title">View Members</div>
        <div class="sidebar-menu-item-subtitle">Manage users</div>
      </div>
      <div class="sidebar-menu-item" onclick="showSection('addMember')">
        <div class="sidebar-menu-item-title">‚ûï</div>
        <div class="sidebar-menu-item-title">Add Member</div>
        <div class="sidebar-menu-item-subtitle">Register user</div>
      </div>
      <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e2e8f0;">
      <div style="padding: 0.5rem 1rem; color: #64748b; font-size: 0.875rem; font-weight: 600;">‚öôÔ∏è Settings</div>
      <div class="sidebar-menu-item" onclick="showSection('profile')">
        <div class="sidebar-menu-item-title">‚úèÔ∏è</div>
        <div class="sidebar-menu-item-title">Edit Profile</div>
        <div class="sidebar-menu-item-subtitle">Update your info</div>
      </div>
      <div class="sidebar-menu-item" onclick="showSection('password')">
        <div class="sidebar-menu-item-title">üîê</div>
        <div class="sidebar-menu-item-title">Change Password</div>
        <div class="sidebar-menu-item-subtitle">Update password</div>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
      <button class="btn btn-sm" onclick="toggleTheme()" style="background: none; border: 1px solid #64748b; color: #64748b; width: auto;">üé®</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
        <h1 style="font-size: 1.5rem; margin: 0;">Asset Manager Pro</h1>
        <span style="color: #64748b;">üëë Admin</span>
      </div>
      <div class="search-box">
        <input type="text" id="searchBox" placeholder="Search items...">
      </div>
    </div>

    <!-- CONTENT AREA -->
    <div class="content-area">
      <!-- ITEMS LIST -->
      <div id="itemsSection">
        <div class="header">
          <h1>üì¶ Inventory Items</h1>
          <p class="header-subtitle">Total: <span id="itemsCount">0</span> items</p>
        </div>
        <table>
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Serial Number</th>
              <th>Holder</th>
              <th>Status</th>
              <th>Condition</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="itemsBody">
            <tr><td colspan="6" style="text-align: center;">No items found</td></tr>
          </tbody>
        </table>
      </div>

      <!-- MEMBERS LIST -->
      <div id="membersSection" class="hidden">
        <div class="header">
          <h1>üë• Team Members</h1>
          <p class="header-subtitle">Total: <span id="membersCount">0</span> members</p>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="membersBody">
            <tr><td colspan="5" style="text-align: center;">No members found</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->

<!-- Notification Modal -->
<div id="notificationModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">üìß Send Notification</h2>
      <button class="modal-close" onclick="closeModal('notificationModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div id="notifyRecipientInfo" class="notify-recipient"></div>
      <div class="form-group">
        <label>Subject *</label>
        <input type="text" id="notifySubject" placeholder="Enter subject">
      </div>
      <div class="form-group">
        <label>Message *</label>
        <textarea id="notifyMessage" rows="6" placeholder="Enter message..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('notificationModal')">Cancel</button>
      <button class="btn btn-primary" id="sendNotifyBtn" onclick="sendNotificationEmail()">üì§ Send</button>
    </div>
  </div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚ûï Add Item</h2>
      <button class="modal-close" onclick="closeModal('addItemModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Item Name *</label>
        <input type="text" id="itemName" placeholder="Enter item name" required>
      </div>
      <div class="form-group">
        <label>Serial Number *</label>
        <input type="text" id="itemSerial" placeholder="Enter serial number" required>
      </div>
      <div class="form-group">
        <label>Condition *</label>
        <select id="itemCondition" required>
          <option value="">Select</option>
          <option value="working">‚úì Working</option>
          <option value="not-working">‚úó Not Working</option>
          <option value="na">N/A</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addItemModal')">Cancel</button>
      <button class="btn btn-primary" onclick="addItem()">Add</button>
    </div>
  </div>
</div>

<!-- Assign Item Modal -->
<div id="assignItemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üì§ Assign Item</h2>
      <button class="modal-close" onclick="closeModal('assignItemModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Select Member *</label>
        <select id="assignMemberSelect" required>
          <option value="">Choose member</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('assignItemModal')">Cancel</button>
      <button class="btn btn-primary" onclick="assignItem()">Assign</button>
    </div>
  </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚ûï Add Member</h2>
      <button class="modal-close" onclick="closeModal('addMemberModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="memberName" placeholder="Enter full name" required>
      </div>
      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="memberEmail" placeholder="Enter email" required>
      </div>
      <div class="form-group">
        <label>Mobile</label>
        <input type="tel" id="memberMobile" placeholder="Enter mobile">
      </div>
      <div class="form-group">
        <label>Designation</label>
        <input type="text" id="memberDesignation" placeholder="Enter designation">
      </div>
      <div class="form-group">
        <label>Department</label>
        <input type="text" id="memberDepartment" placeholder="Enter department">
      </div>
      <div class="form-group">
        <label>Password * (Min 6)</label>
        <input type="password" id="memberPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addMemberModal')">Cancel</button>
      <button class="btn btn-primary" onclick="addMember()">Add Member</button>
    </div>
  </div>
</div>

<script>
// ==================== DATABASE INITIALIZATION ====================
let db;
let currentUser = null;
let currentNotifyItemId = null;

// Initialize IndexedDB properly
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('AssetManager', 1);

    request.onerror = () => {
      console.error('Database failed to open');
      reject(request.error);
    };

    request.onsuccess = () => {
      db = request.result;
      console.log('‚úì Database opened successfully');
      resolve(db);
    };

    request.onupgradeneeded = (event) => {
      db = event.target.result;
      console.log('‚úì Creating object stores...');

      // Create object stores if they don't exist
      if (!db.objectStoreNames.contains('members')) {
        db.createObjectStore('members', { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains('items')) {
        db.createObjectStore('items', { keyPath: 'id' });
      }
    };
  });
}

// ==================== DATABASE OPERATIONS ====================
async function getAll(storeName) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readonly');
    const objectStore = transaction.objectStore(storeName);
    const request = objectStore.getAll();

    request.onerror = () => {
      console.error(`Error reading ${storeName}:`, request.error);
      reject(request.error);
    };

    request.onsuccess = () => {
      resolve(request.result);
    };
  });
}

async function saveItem(storeName, item) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readwrite');
    const objectStore = transaction.objectStore(storeName);
    const request = objectStore.put(item);

    request.onerror = () => {
      console.error(`Error saving to ${storeName}:`, request.error);
      reject(request.error);
    };

    request.onsuccess = () => {
      resolve(item);
    };
  });
}

async function deleteItem(storeName, id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readwrite');
    const objectStore = transaction.objectStore(storeName);
    const request = objectStore.delete(id);

    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve();
  });
}

// ==================== AUTH FUNCTIONS ====================
async function registerAdmin(e) {
  e.preventDefault();
  const name = document.getElementById('setupName').value.trim();
  const email = document.getElementById('setupEmail').value.trim();
  const mobile = document.getElementById('setupMobile').value.trim();
  const designation = document.getElementById('setupDesignation').value.trim();
  const department = document.getElementById('setupDepartment').value.trim();
  const password = document.getElementById('setupPassword').value;
  const confirmPassword = document.getElementById('setupConfirmPassword').value;

  if (password !== confirmPassword) {
    alert('‚ùå Passwords do not match');
    return;
  }

  const admin = {
    id: Date.now().toString(),
    name, email, mobile, designation, department, password,
    role: 'admin',
    createdAt: new Date().toISOString()
  };

  try {
    await saveItem('members', admin);
    localStorage.setItem('currentUser', JSON.stringify(admin));
    currentUser = admin;
    showMainScreen();
    alert('‚úÖ Admin account created successfully!');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

function showLogin() {
  document.getElementById('setupForm').classList.add('hidden');
  document.getElementById('loginForm').classList.remove('hidden');
}

function showSetup() {
  document.getElementById('setupForm').classList.remove('hidden');
  document.getElementById('loginForm').classList.add('hidden');
}

async function login(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  try {
    const members = await getAll('members');
    const user = members.find(m => m.email === email && m.password === password);

    if (user) {
      localStorage.setItem('currentUser', JSON.stringify(user));
      currentUser = user;
      showMainScreen();
    } else {
      alert('‚ùå Invalid email or password');
    }
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('currentUser');
    currentUser = null;
    showAuthScreen();
  }
}

// ==================== UI FUNCTIONS ====================
function showAuthScreen() {
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('mainScreen').classList.add('hidden');

  // Check if setup needed
  const checkMembers = new Promise((resolve) => {
    const transaction = db.transaction(['members'], 'readonly');
    const objectStore = transaction.objectStore('members');
    const request = objectStore.getAll();
    request.onsuccess = () => resolve(request.result.length === 0);
  });

  checkMembers.then(isEmpty => {
    if (isEmpty) {
      showSetup();
    } else {
      showLogin();
    }
  });
}

function showMainScreen() {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('mainScreen').classList.remove('hidden');
  showSection('items');
}

function showSection(section) {
  document.querySelectorAll('[id$="Section"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(section + 'Section').classList.remove('hidden');
  document.querySelectorAll('.sidebar-menu-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.sidebar-menu-item').classList.add('active');

  if (section === 'items') renderItems();
  if (section === 'members') renderMembers();
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function toggleTheme() {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
}

// ==================== ITEMS FUNCTIONS ====================
async function renderItems() {
  try {
    const items = await getAll('items');
    const members = await getAll('members');
    const tbody = document.getElementById('itemsBody');
    const count = document.getElementById('itemsCount');

    count.textContent = items.length;

    if (items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No items found</td></tr>';
      return;
    }

    tbody.innerHTML = items.map(item => {
      const member = members.find(m => m.id === item.holder);
      const status = item.holder ? 'üì§ Out' : '‚úì Available';
      const statusClass = item.holder ? 'badge-orange' : 'badge-green';
      const cond = item.condition === 'working' ? '‚úì Working' : item.condition === 'not-working' ? '‚úó Not Working' : 'N/A';
      const condClass = item.condition === 'working' ? 'badge-green' : item.condition === 'not-working' ? 'badge-red' : 'badge-orange';

      return `<tr>
        <td>${item.name}</td>
        <td>${item.serial}</td>
        <td>${member ? member.name : '-'}</td>
        <td><span class="badge ${statusClass}">${status}</span></td>
        <td><span class="badge ${condClass}">${cond}</span></td>
        <td class="actions">
          <button class="btn-icon" onclick="editItem('${item.id}')" title="Edit">‚úèÔ∏è</button>
          ${item.holder ? `<button class="btn-icon" onclick="openNotifyModal('${item.id}')" title="Notify">üîî</button>` : ''}
          ${item.holder ? `<button class="btn-icon" onclick="returnItem('${item.id}')" title="Return">üì•</button>` : `<button class="btn-icon" onclick="openAssignModal('${item.id}')" title="Assign">üì¶</button>`}
          <button class="btn-icon" onclick="deleteItemFunc('${item.id}')" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  } catch (error) {
    console.error('Error rendering items:', error);
  }
}

async function addItem() {
  const name = document.getElementById('itemName').value.trim();
  const serial = document.getElementById('itemSerial').value.trim();
  const condition = document.getElementById('itemCondition').value;

  if (!name || !serial || !condition) {
    alert('‚ùå Fill all required fields');
    return;
  }

  try {
    const item = {
      id: Date.now().toString(),
      name, serial, condition,
      holder: '',
      createdAt: new Date().toISOString()
    };

    await saveItem('items', item);
    closeModal('addItemModal');
    document.getElementById('itemName').value = '';
    document.getElementById('itemSerial').value = '';
    document.getElementById('itemCondition').value = '';
    renderItems();
    alert('‚úÖ Item added successfully!');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function editItem(itemId) {
  const items = await getAll('items');
  const item = items.find(i => i.id === itemId);
  if (!item) return;

  const newName = prompt('Item Name:', item.name);
  if (newName === null) return;

  const newSerial = prompt('Serial Number:', item.serial);
  if (newSerial === null) return;

  item.name = newName;
  item.serial = newSerial;
  await saveItem('items', item);
  renderItems();
  alert('‚úÖ Item updated!');
}

async function deleteItemFunc(itemId) {
  if (!confirm('Delete this item?')) return;
  try {
    await deleteItem('items', itemId);
    renderItems();
    alert('‚úÖ Item deleted!');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function returnItem(itemId) {
  try {
    const items = await getAll('items');
    const item = items.find(i => i.id === itemId);
    item.holder = '';
    await saveItem('items', item);
    renderItems();
    alert('‚úÖ Item returned!');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function openAssignModal(itemId) {
  currentEditItemId = itemId;
  try {
    const members = await getAll('members');
    const select = document.getElementById('assignMemberSelect');
    select.innerHTML = '<option value="">Choose member</option>' + 
      members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
    document.getElementById('assignItemModal').classList.add('active');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function assignItem() {
  const selectedMemberId = document.getElementById('assignMemberSelect').value;
  if (!selectedMemberId) {
    alert('‚ùå Select a member');
    return;
  }

  try {
    const items = await getAll('items');
    const members = await getAll('members');
    const item = items.find(i => i.id === currentEditItemId);
    const member = members.find(m => m.id === selectedMemberId);

    item.holder = selectedMemberId;
    await saveItem('items', item);

    // Send email notification
    await sendItemAssignmentEmail(member.email, member.name, item.name, item.serial);

    closeModal('assignItemModal');
    renderItems();
    alert('‚úÖ Item assigned successfully! Email sent to member.');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

// ==================== MEMBERS FUNCTIONS ====================
async function renderMembers() {
  try {
    const members = await getAll('members');
    const tbody = document.getElementById('membersBody');
    const count = document.getElementById('membersCount');

    count.textContent = members.length;

    if (members.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No members found</td></tr>';
      return;
    }

    tbody.innerHTML = members.map(member => {
      return `<tr>
        <td>${member.name}</td>
        <td>${member.email}</td>
        <td>${member.role || 'User'}</td>
        <td>${member.department || '-'}</td>
        <td class="actions">
          <button class="btn-icon" onclick="editMember('${member.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="btn-icon" onclick="deleteMember('${member.id}')" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  } catch (error) {
    console.error('Error rendering members:', error);
  }
}

async function addMember() {
  const name = document.getElementById('memberName').value.trim();
  const email = document.getElementById('memberEmail').value.trim();
  const mobile = document.getElementById('memberMobile').value.trim();
  const designation = document.getElementById('memberDesignation').value.trim();
  const department = document.getElementById('memberDepartment').value.trim();
  const password = document.getElementById('memberPassword').value;

  if (!name || !email || !password) {
    alert('‚ùå Fill all required fields');
    return;
  }

  try {
    const newMember = {
      id: Date.now().toString(),
      name, email, mobile, designation, department, password,
      role: 'user',
      createdAt: new Date().toISOString()
    };

    await saveItem('members', newMember);

    // Send welcome email
    await sendMemberWelcomeEmail(email, name, password);

    closeModal('addMemberModal');
    document.getElementById('memberName').value = '';
    document.getElementById('memberEmail').value = '';
    document.getElementById('memberMobile').value = '';
    document.getElementById('memberDesignation').value = '';
    document.getElementById('memberDepartment').value = '';
    document.getElementById('memberPassword').value = '';
    
    renderMembers();
    alert('‚úÖ Member added! Welcome email sent.');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function editMember(memberId) {
  const members = await getAll('members');
  const member = members.find(m => m.id === memberId);
  if (!member) return;

  const newName = prompt('Name:', member.name);
  if (newName === null) return;

  member.name = newName;
  await saveItem('members', member);
  renderMembers();
  alert('‚úÖ Member updated!');
}

async function deleteMember(memberId) {
  if (!confirm('Delete this member?')) return;
  try {
    await deleteItem('members', memberId);
    renderMembers();
    alert('‚úÖ Member deleted!');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

// ==================== NOTIFICATION FUNCTIONS ====================
async function openNotifyModal(itemId) {
  currentNotifyItemId = itemId;
  try {
    const items = await getAll('items');
    const members = await getAll('members');

    const item = items.find(i => i.id === itemId);
    if (!item || !item.holder) {
      alert('‚ùå No holder assigned');
      return;
    }

    const member = members.find(m => m.id === item.holder);
    if (!member || !member.email) {
      alert('‚ùå Member or email not found');
      return;
    }

    document.getElementById('notifyRecipientInfo').textContent = 
      `üìß Sending to: ${member.name} (${member.email})`;
    document.getElementById('notifySubject').value = `Notification: ${item.name}`;
    document.getElementById('notifyMessage').value = 
      `Hi ${member.name},\n\nThis is regarding the item "${item.name}" (Serial: ${item.serial}) currently assigned to you.\n\nPlease confirm receipt.\n\nBest regards,\n${currentUser.name || 'Admin'}`;

    document.getElementById('notificationModal').classList.add('active');
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function sendEmailViaBackend(toEmail, subject, body, fromEmail) {
  try {
    const response = await fetch('http://localhost:3000/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: toEmail, subject, body, from: fromEmail })
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    return data.success === true;
  } catch (error) {
    console.error('Email error:', error);
    alert('‚ö†Ô∏è Email backend not available:\n' + error.message + '\n\nRun: npm start');
    return false;
  }
}

async function sendNotificationEmail() {
  const subject = document.getElementById('notifySubject').value.trim();
  const message = document.getElementById('notifyMessage').value.trim();

  if (!subject || !message) {
    alert('‚ùå Fill subject and message');
    return;
  }

  try {
    const items = await getAll('items');
    const members = await getAll('members');

    const item = items.find(i => i.id === currentNotifyItemId);
    const member = members.find(m => m.id === item.holder);

    const btn = document.getElementById('sendNotifyBtn');
    btn.innerText = 'üì§ Sending...';
    btn.disabled = true;

    const success = await sendEmailViaBackend(
      member.email,
      subject,
      message,
      currentUser.email || 'admin@assetmanager.com'
    );

    btn.innerText = 'üì§ Send';
    btn.disabled = false;

    if (success) {
      alert('‚úÖ Email sent!');
      closeModal('notificationModal');
    }
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

async function sendMemberWelcomeEmail(email, name, password) {
  await sendEmailViaBackend(
    email,
    'üéâ Profile Created - Asset Manager',
    `Hi ${name},\n\nYour profile has been created!\n\nEmail: ${email}\nPassword: ${password}\n\nBest regards,\nAsset Manager Team`,
    currentUser.email || 'admin@assetmanager.com'
  );
}

async function sendItemAssignmentEmail(memberEmail, memberName, itemName, itemSerial) {
  await sendEmailViaBackend(
    memberEmail,
    `üì¶ Item Assignment: ${itemName}`,
    `Hi ${memberName},\n\nYou have been assigned:\n\nItem: ${itemName}\nSerial: ${itemSerial}\n\nPlease confirm receipt.\n\nBest regards,\nAsset Manager Team`,
    currentUser.email || 'admin@assetmanager.com'
  );
}

// ==================== INITIALIZATION ====================
window.addEventListener('load', async () => {
  const theme = localStorage.getItem('theme') || 'light';
  if (theme === 'dark') {
    document.documentElement.classList.add('dark');
  }

  try {
    await initDB();

    const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (user) {
      currentUser = user;
      showMainScreen();
    } else {
      showAuthScreen();
    }
  } catch (error) {
    alert('‚ùå Database error: ' + error.message);
  }
});

// Close modals on ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(modal => {
      modal.classList.remove('active');
    });
  }
});

// Close modals on backdrop click
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
    }
  });
});
</script>

</body>
</html>