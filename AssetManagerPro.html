<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asset Manager Pro - Professional Inventory System</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      scroll-behavior: smooth;
    }

    html:not(.dark) {
      background-color: #f8fafc;
      color: #0f172a;
    }

    html.dark {
      background-color: #0d1117;
      color: #e6edf3;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.2s ease, color 0.2s ease;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    html.dark ::-webkit-scrollbar-thumb {
      background: #30363d;
    }

    html.dark ::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }

    .hidden {
      display: none !important;
    }

    .auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      padding: 2rem 1rem;
      overflow-y: auto;
    }

    .auth-screen.hidden {
      display: none !important;
    }

    .auth-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      padding: 2.5rem;
      max-width: 480px;
      width: 100%;
      animation: slideInUp 0.4s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    html.dark .auth-card {
      background: #161b22;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .auth-title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 2rem;
    }

    .auth-title h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .auth-title p {
      color: #64748b;
      font-size: 0.875rem;
    }

    .setup-alert {
      background: #dbeafe;
      color: #0c4a6e;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      border: 1px solid #7dd3fc;
      font-size: 0.875rem;
    }

    html.dark .setup-alert {
      background: #0c3d5f;
      color: #7dd3fc;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem 0.875rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: white;
      color: #0f172a;
      font-family: Inter, sans-serif;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    html.dark input,
    html.dark select,
    html.dark textarea {
      background: #0d1117;
      border-color: #30363d;
      color: #c9d1d9;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-family: Inter, sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
      width: 100%;
      margin-top: 1rem;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-icon {
      background: none;
      border: none;
      padding: 0.5rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 1.2rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    html.dark .btn-icon:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .auth-links {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .auth-links a {
      color: #2563eb;
      cursor: pointer;
      font-weight: 500;
      text-decoration: none;
    }

    header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 40;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    html.dark header {
      background: #161b22;
      border-bottom-color: #30363d;
    }

    main {
      flex: 1;
      width: 100%;
      z-index: 10;
      overflow-y: auto;
      padding: 2rem;
    }

    .card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      overflow-x: auto;
      margin-bottom: 2rem;
    }

    html.dark .card {
      background: #161b22;
      border-color: #30363d;
    }

    table {
      width: 100%;
      font-size: 0.875rem;
      border-collapse: collapse;
    }

    thead tr {
      border-bottom: 2px solid #e2e8f0;
    }

    html.dark thead tr {
      border-bottom-color: #30363d;
    }

    tbody tr {
      border-bottom: 1px solid #e2e8f0;
      transition: background-color 0.2s ease;
    }

    html.dark tbody tr {
      border-bottom-color: #30363d;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    html.dark tbody tr:hover {
      background: #21262d;
    }

    tbody tr.edit-row {
      background: rgba(37, 99, 235, 0.1);
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #64748b;
    }

    .badge {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }

    .badge-green {
      background: #dcfce7;
      color: #166534;
    }

    .badge-orange {
      background: #fed7aa;
      color: #92400e;
    }

    .badge-notworking {
      background: #fee2e2;
      color: #991b1b;
    }

    html.dark .badge-green {
      background: #0d3f1a;
      color: #3fb950;
    }

    html.dark .badge-orange {
      background: #3d2817;
      color: #d29922;
    }

    .backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 40;
    }

    .backdrop.show {
      display: block;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideInUp 0.3s ease;
    }

    html.dark .modal-content {
      background: #161b22;
    }

    .modal-header {
      border-bottom: 1px solid #e2e8f0;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    html.dark .modal-header {
      border-bottom-color: #30363d;
    }

    .modal-header h3 {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-footer {
      border-top: 1px solid #e2e8f0;
      padding: 1.5rem;
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    html.dark .modal-footer {
      border-top-color: #30363d;
    }

    .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #64748b;
      font-size: 1.5rem;
      padding: 0;
    }

    .panel {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: 100%;
      max-width: 320px;
      z-index: 50;
      background: rgba(13, 17, 23, 0.95);
      backdrop-filter: blur(10px);
      border-left: 1px solid rgba(48, 54, 61, 0.4);
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s;
    }

    .panel.open {
      transform: translateX(0);
    }

    .panel-header {
      position: sticky;
      top: 0;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(13, 17, 23, 0.8);
      border-bottom: 1px solid rgba(48, 54, 61, 0.3);
      z-index: 10;
    }

    .panel-header h3 {
      font-size: 1.125rem;
      font-weight: bold;
      color: white;
    }

    .panel-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .panel-item {
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(48, 54, 61, 0.6);
      background: rgba(30, 40, 54, 0.4);
      backdrop-filter: blur(5px);
      cursor: pointer;
      color: white;
      transition: all 0.2s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }

    .panel-item:hover {
      background: rgba(30, 40, 54, 0.7);
      border-color: rgba(88, 166, 255, 0.5);
    }

    .panel-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .icon-blue {
      background: rgba(59, 130, 246, 0.2);
      color: #58a6ff;
    }

    .icon-purple {
      background: rgba(139, 92, 246, 0.2);
      color: #d084d0;
    }

    .icon-red {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .panel-item-content {
      flex: 1;
    }

    .panel-item-title {
      font-weight: 600;
      color: white;
      font-size: 0.9375rem;
      margin-bottom: 0.25rem;
    }

    .panel-item-desc {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .item-count-badge {
      padding: 0.5rem 1.25rem;
      background: #f3e8ff;
      color: #6b21a8;
      font-size: 0.875rem;
      font-weight: bold;
      border-radius: 9999px;
    }

    .theme-section {
      border-top: 1px solid rgba(48, 54, 61, 0.3);
      padding-top: 1rem;
      margin-top: 1rem;
    }

    .theme-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
      margin-bottom: 0.75rem;
    }

    .theme-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .theme-btn {
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 2px solid #30363d;
      background: rgba(30, 40, 54, 0.5);
      color: white;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .theme-btn.active {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.2);
    }

    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 2rem;
    }

    html.dark .tabs {
      border-bottom-color: #30363d;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 1rem 2rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }

    html.dark .tab-btn {
      color: #94a3b8;
    }

    html.dark .tab-btn.active {
      color: #58a6ff;
      border-bottom-color: #58a6ff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    @media (max-width: 768px) {
      .auth-card {
        padding: 2rem;
        margin: 1rem;
      }

      main {
        padding: 1rem;
      }

      header {
        padding: 0.75rem 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <div id="authScreen">
    <div class="auth-card">
      <div class="auth-title">
        <div class="logo-icon">üì¶</div>
        <h1>Asset Manager Pro</h1>
        <p>Professional Inventory System</p>
      </div>

      <!-- REGISTRATION FORM -->
      <form id="registerForm" class="hidden">
        <div class="setup-alert">
          <strong>üîß First Time Setup</strong><br>
          <small>You will be the admin</small>
        </div>

        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" name="name" placeholder="Enter your name" required>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input type="email" name="email" placeholder="Enter your email" required>
        </div>

        <div class="form-group">
          <label>Mobile</label>
          <input type="tel" name="mobile" placeholder="Enter mobile">
        </div>

        <div class="form-group">
          <label>Designation</label>
          <input type="text" name="designation" placeholder="e.g., Manager">
        </div>

        <div class="form-group">
          <label>Department</label>
          <input type="text" name="department" placeholder="e.g., IT">
        </div>

        <div class="form-group">
          <label>Password * (Min 6)</label>
          <input type="password" name="password" required>
        </div>

        <div class="form-group">
          <label>Confirm Password *</label>
          <input type="password" name="confirmPassword" required>
        </div>

        <button type="submit" class="btn btn-primary">üëë Create Admin Account</button>

        <div class="auth-links">Already registered? <a onclick="switchToLogin()">Sign In</a></div>
      </form>

      <!-- LOGIN FORM -->
      <form id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" placeholder="Enter email" required>
        </div>

        <div class="form-group">
          <label>Password</label>
          <input type="password" name="password" placeholder="Enter password" required>
        </div>

        <button type="submit" class="btn btn-primary">üîì Sign In</button>

        <div class="auth-links">New user? Ask your admin to add you.</div>
      </form>
    </div>
  </div>

  <!-- HEADER -->
  <header class="hidden" id="mainHeader">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <h1 style="font-size: 1.25rem; font-weight: 700;">Asset Manager Pro</h1>
      <p id="userRole" style="color: #64748b; font-size: 0.875rem;">Admin</p>
    </div>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <button id="openManage" class="btn btn-primary" style="display: none; width: auto;">üìã Menu</button>
      <button id="settingsBtn" class="btn-icon">‚öôÔ∏è</button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="hidden" id="mainContent">
    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('assets')">üì¶ Assets</button>
      <button class="tab-btn" onclick="switchTab('consumables')">üì¶ Consumables</button>
    </div>

    <!-- ASSETS TAB -->
    <div id="assets-tab" class="tab-content active">
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
          <h2 style="font-size: 1.5rem; font-weight: 700;">üì¶ Inventory Items</h2>
          <span class="item-count-badge" id="assetsCount">0</span>
        </div>

        <div style="overflow-x: auto;">
          <table id="assetsTable">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Serial Number</th>
                <th>Holder</th>
                <th>Status</th>
                <th>Condition</th>
                <th style="min-width: 200px;">Actions</th>
              </tr>
            </thead>
            <tbody id="assetsBody">
              <tr>
                <td colspan="6" style="text-align: center;">No items found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CONSUMABLES TAB -->
    <div id="consumables-tab" class="tab-content">
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
          <h2 style="font-size: 1.5rem; font-weight: 700;">üì¶ Consumable Items</h2>
          <span class="item-count-badge" id="consumablesCount">0</span>
        </div>

        <div style="overflow-x: auto;">
          <table id="consumablesTable">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Part Number</th>
                <th>Quantity</th>
                <th style="min-width: 200px;">Actions</th>
              </tr>
            </thead>
            <tbody id="consumablesBody">
              <tr>
                <td colspan="4" style="text-align: center;">No consumables found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- BACKDROP -->
  <div id="backdrop" class="backdrop"></div>

  <!-- MANAGE PANEL -->
  <div id="managePanel" class="panel">
    <div class="panel-header">
      <h3>üìã Menu</h3>
      <button id="closeManage" type="button" class="close-btn">‚úï</button>
    </div>
    <div class="panel-body">
      <button id="viewItemsBtn" type="button" class="panel-item">
        <div class="panel-item-icon icon-blue">üì¶</div>
        <div class="panel-item-content">
          <div class="panel-item-title">View Items</div>
          <div class="panel-item-desc">Browse all items</div>
        </div>
      </button>

      <button id="addItemBtn" type="button" class="panel-item" style="display: none;">
        <div class="panel-item-icon icon-blue">‚ûï</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Add Item</div>
          <div class="panel-item-desc">Create new</div>
        </div>
      </button>

      <button id="viewMembersBtn" type="button" class="panel-item">
        <div class="panel-item-icon icon-purple">üë•</div>
        <div class="panel-item-content">
          <div class="panel-item-title">View Members</div>
          <div class="panel-item-desc">Manage users</div>
        </div>
      </button>

      <button id="addMemberBtn" type="button" class="panel-item" style="display: none;">
        <div class="panel-item-icon icon-purple">‚ûï</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Add Member</div>
          <div class="panel-item-desc">Register user</div>
        </div>
      </button>
    </div>
  </div>

  <!-- SETTINGS PANEL -->
  <div id="settingsPanel" class="panel">
    <div class="panel-header">
      <h3>‚öôÔ∏è Settings</h3>
      <button id="closeSettings" type="button" class="close-btn">‚úï</button>
    </div>
    <div class="panel-body">
      <button id="editProfileBtn" type="button" class="panel-item">
        <div class="panel-item-icon icon-blue">‚úèÔ∏è</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Edit Profile</div>
          <div class="panel-item-desc">Update your info</div>
        </div>
      </button>

      <button id="changePasswordBtn" type="button" class="panel-item">
        <div class="panel-item-icon icon-purple">üîê</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Change Password</div>
          <div class="panel-item-desc">Update password</div>
        </div>
      </button>

      <button id="exportBtn" type="button" class="panel-item" style="display: none;">
        <div class="panel-item-icon icon-blue">üì§</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Export to File</div>
          <div class="panel-item-desc">Download backup JSON</div>
        </div>
      </button>

      <button id="syncFromGithubBtn" type="button" class="panel-item" style="display: none;">
        <div class="panel-item-icon icon-blue">‚òÅÔ∏è</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Sync from GitHub</div>
          <div class="panel-item-desc">Load shared data</div>
        </div>
      </button>

      <button id="removeAccountBtn" type="button" class="panel-item">
        <div class="panel-item-icon icon-red">üóëÔ∏è</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Remove Account</div>
          <div class="panel-item-desc">Delete your account</div>
        </div>
      </button>

      <button id="logoutBtn" type="button" class="panel-item">
        <div class="panel-item-icon icon-red">üö™</div>
        <div class="panel-item-content">
          <div class="panel-item-title">Logout</div>
          <div class="panel-item-desc">Sign out</div>
        </div>
      </button>

      <div class="theme-section">
        <label class="theme-label">üé® Theme</label>
        <div class="theme-buttons">
          <button id="lightBtn" type="button" class="theme-btn">‚òÄÔ∏è Light</button>
          <button id="darkBtn" type="button" class="theme-btn active">üåô Dark</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ITEM TYPE SELECTOR MODAL -->
  <div id="itemTypeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ûï Add Item</h3>
        <button type="button" class="close-btn" onclick="closeModal('itemTypeModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 2rem; text-align: center;">What type of item do you want to add?</p>
        <button type="button" class="btn btn-primary" onclick="openAddAssetModal()" style="margin-bottom: 1rem;">üì¶ Asset Item</button>
        <button type="button" class="btn btn-primary" onclick="openAddConsumableModal()">üì¶ Consumable Item</button>
      </div>
    </div>
  </div>

  <!-- ADD ASSET MODAL -->
  <div id="addAssetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ûï Add Asset</h3>
        <button type="button" class="close-btn" onclick="closeModal('addAssetModal')">‚úï</button>
      </div>
      <form id="assetForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Item Name *</label>
            <input type="text" name="name" placeholder="e.g., Laptop" required>
          </div>
          <div class="form-group">
            <label>Serial Number *</label>
            <input type="text" name="serial" placeholder="e.g., SN123456" required>
          </div>
          <div class="form-group">
            <label>Condition *</label>
            <select name="condition" required>
              <option value="">Select</option>
              <option value="working">‚úì Working</option>
              <option value="not-working">‚úó Not Working</option>
              <option value="not-applicable">N/A - Not Applicable</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('addAssetModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ADD CONSUMABLE MODAL -->
  <div id="addConsumableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ûï Add Consumable</h3>
        <button type="button" class="close-btn" onclick="closeModal('addConsumableModal')">‚úï</button>
      </div>
      <form id="consumableForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Item Name *</label>
            <input type="text" name="name" placeholder="e.g., Solder Wire" required>
          </div>
          <div class="form-group">
            <label>Part Number *</label>
            <input type="text" name="partNumber" placeholder="e.g., PN123456" required>
          </div>
          <div class="form-group">
            <label>Quantity *</label>
            <input type="number" name="quantity" placeholder="e.g., 100" min="1" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('addConsumableModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT ASSET MODAL -->
  <div id="editAssetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Edit Asset</h3>
        <button type="button" class="close-btn" onclick="closeModal('editAssetModal')">‚úï</button>
      </div>
      <form id="editAssetForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="editAssetName" required>
          </div>
          <div class="form-group">
            <label>Serial Number</label>
            <input type="text" id="editAssetSerial" required>
          </div>
          <div class="form-group">
            <label>Condition</label>
            <select id="editAssetCond" required>
              <option value="working">‚úì Working</option>
              <option value="not-working">‚úó Not Working</option>
              <option value="not-applicable">N/A - Not Applicable</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editAssetModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT CONSUMABLE MODAL -->
  <div id="editConsumableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Edit Consumable</h3>
        <button type="button" class="close-btn" onclick="closeModal('editConsumableModal')">‚úï</button>
      </div>
      <form id="editConsumableForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="editConsName" required>
          </div>
          <div class="form-group">
            <label>Part Number</label>
            <input type="text" id="editConsPartNumber" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editConsumableModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ADD QUANTITY MODAL -->
  <div id="addQuantityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ûï Add Quantity</h3>
        <button type="button" class="close-btn" onclick="closeModal('addQuantityModal')">‚úï</button>
      </div>
      <form id="addQuantityForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="quantityItemName" disabled>
          </div>
          <div class="form-group">
            <label>Quantity to Add *</label>
            <input type="number" id="quantityToAdd" min="1" placeholder="Enter quantity" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('addQuantityModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Add Quantity</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ASSIGN CONSUMABLE MODAL -->
  <div id="assignConsumableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì§ Assign Consumable</h3>
        <button type="button" class="close-btn" onclick="closeModal('assignConsumableModal')">‚úï</button>
      </div>
      <form id="assignConsumableForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="assignConsItemName" disabled>
          </div>
          <div class="form-group">
            <label>Available Quantity</label>
            <input type="text" id="assignConsAvailQty" disabled>
          </div>
          <div class="form-group">
            <label>Select Member *</label>
            <select id="assignConsMember" required>
              <option value="">Choose member</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity to Assign *</label>
            <input type="number" id="assignConsQty" min="1" placeholder="Enter quantity" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('assignConsumableModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ASSIGN ASSET MODAL -->
  <div id="assignAssetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì§ Assign Asset</h3>
        <button type="button" class="close-btn" onclick="closeModal('assignAssetModal')">‚úï</button>
      </div>
      <form id="assignAssetForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Select Member *</label>
            <select id="assignAssetMember" required>
              <option value="">Choose member</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('assignAssetModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <!-- RETURN ASSET MODAL -->
  <div id="returnAssetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì• Return Asset</h3>
      </div>
      <div class="modal-body">
        <p>Return this asset to inventory?</p>
        <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;" id="returnAssetInfo"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('returnAssetModal')">Cancel</button>
        <button type="button" class="btn btn-success" onclick="confirmReturnAsset()">Return</button>
      </div>
    </div>
  </div>

  <!-- DELETE MODAL -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div style="text-align: center; padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üóëÔ∏è</div>
        <h3>Delete Item?</h3>
        <p style="color: #64748b; margin-bottom: 2rem; font-size: 0.95rem;">This action cannot be undone.</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìú Item History</h3>
        <button type="button" class="close-btn" onclick="closeModal('historyModal')">‚úï</button>
      </div>
      <div class="modal-body" id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- EDIT PROFILE MODAL -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Edit Profile</h3>
        <button type="button" class="close-btn" onclick="closeModal('editProfileModal')">‚úï</button>
      </div>
      <form id="editProfileForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="editName" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="editEmail" required>
          </div>
          <div class="form-group">
            <label>Mobile</label>
            <input type="tel" id="editMobile">
          </div>
          <div class="form-group">
            <label>Designation</label>
            <input type="text" id="editDesignation">
          </div>
          <div class="form-group">
            <label>Department</label>
            <input type="text" id="editDepartment">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editProfileModal')">Cancel</button>
          <button type="submit" class="btn btn-success">‚úì Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîê Change Password</h3>
        <button type="button" class="close-btn" onclick="closeModal('changePasswordModal')">‚úï</button>
      </div>
      <form id="changePasswordForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Current Password *</label>
            <input type="password" id="currentPassword" required>
          </div>
          <div class="form-group">
            <label>New Password *</label>
            <input type="password" id="newPassword" required>
          </div>
          <div class="form-group">
            <label>Confirm Password *</label>
            <input type="password" id="confirmNewPassword" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ADD MEMBER MODAL -->
  <div id="addMemberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üë§ Add Member</h3>
        <button type="button" class="close-btn" onclick="closeModal('addMemberModal')">‚úï</button>
      </div>
      <form id="memberForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" name="name" placeholder="Name" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" name="email" placeholder="Email" required>
          </div>
          <div class="form-group">
            <label>Mobile</label>
            <input type="tel" name="mobile">
          </div>
          <div class="form-group">
            <label>Designation</label>
            <input type="text" name="designation">
          </div>
          <div class="form-group">
            <label>Department</label>
            <input type="text" name="department">
          </div>
          <div class="form-group">
            <label>Password * (Min 6)</label>
            <input type="password" name="password" required>
          </div>
          <div class="form-group">
            <label>Confirm Password *</label>
            <input type="password" name="confirmPassword" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">Cancel</button>
          <button type="submit" class="btn btn-success">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MEMBERS MODAL -->
  <div id="membersModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üë• Members</h3>
        <button type="button" class="close-btn" onclick="closeModal('membersModal')">‚úï</button>
      </div>
      <div class="modal-body" id="membersList" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <script>
    // ========== GITHUB CONFIG ==========
    const GITHUBRAWURL = 'https://raw.githubusercontent.com/riyasma07/asset-manager-db/main/data.json';

    // ========== DATABASE SETUP ==========
    const DBNAME = 'AssetManagerProDB';
    let db = null;
    let currentUser = null;
    let isAdmin = false;
    let editingItemId = null;
    let editingItemType = null;
    let deletingItemId = null;
    let deletingItemType = null;
    let returningAssetId = null;

    async function initDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DBNAME, 2);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => {
          db = req.result;
          console.log('‚úì Database initialized');
          resolve(db);
        };
        req.onupgradeneeded = (e) => {
          const database = e.target.result;
          if (!database.objectStoreNames.contains('users')) {
            database.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
          }
          if (!database.objectStoreNames.contains('assets')) {
            database.createObjectStore('assets', { keyPath: 'id', autoIncrement: true });
          }
          if (!database.objectStoreNames.contains('consumables')) {
            database.createObjectStore('consumables', { keyPath: 'id', autoIncrement: true });
          }
          if (!database.objectStoreNames.contains('history')) {
            database.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    function getAll(storeName) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const req = store.getAll();
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
      });
    }

    function addRecord(storeName, data) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const req = store.add(data);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
      });
    }

    function updateRecord(storeName, data) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const req = store.put(data);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
      });
    }

    function getOne(storeName, id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const req = store.get(id);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
      });
    }

    function deleteRecord(storeName, id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const req = store.delete(id);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
      });
    }

    function clearStore(storeName) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const req = tx.objectStore(storeName).clear();
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    // ========== AUTO SYNC FROM GITHUB ==========
    async function autoSyncFromGithub() {
      try {
        console.log('üîÑ Syncing from GitHub...');
        const res = await fetch(GITHUBRAWURL);
        if (!res.ok) {
          console.warn('GitHub file not found');
          return;
        }

        const data = await res.json();
        if (data.__schema__ !== 'asset-manager-pro') {
          console.warn('Invalid data schema');
          return;
        }

        await clearStore('users');
        await clearStore('assets');
        await clearStore('consumables');
        await clearStore('history');

        for (const u of data.users) {
          await addRecord('users', u);
        }
        for (const a of data.assets || []) {
          await addRecord('assets', a);
        }
        for (const c of data.consumables || []) {
          await addRecord('consumables', c);
        }
        for (const h of data.history || []) {
          await addRecord('history', h);
        }

        console.log('‚úì Auto-synced from GitHub!');
      } catch (e) {
        console.warn('Sync failed:', e.message);
      }
    }

    // ========== SEND EMAIL FUNCTION ==========
    async function sendEmailNotification(recipient, subject, body, itemInfo) {
      try {
        const response = await fetch('http://localhost:3000/api/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            to: recipient,
            subject: subject,
            body: body,
            itemInfo: itemInfo,
            from: currentUser.email
          })
        });

        if (response.ok) {
          const data = await response.json();
          console.log('‚úì Email sent:', data);
          return true;
        } else {
          console.warn('Email send failed:', response.status);
          return false;
        }
      } catch (e) {
        console.error('Email error:', e);
        alert('Email notification queued (backend may be offline)');
        return false;
      }
    }

    // ========== UI FUNCTIONS ==========
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      if (tab === 'assets') {
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
        document.getElementById('assets-tab').classList.add('active');
      } else if (tab === 'consumables') {
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.getElementById('consumables-tab').classList.add('active');
      }
    }

    function switchToLogin() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
      if (!document.querySelectorAll('.modal.show').length && !document.querySelectorAll('.panel.open').length) {
        document.getElementById('backdrop').classList.remove('show');
      }
    }

    function closePanel(id) {
      document.getElementById(id).classList.remove('open');
      if (!document.querySelectorAll('.modal.show').length && !document.querySelectorAll('.panel.open').length) {
        document.getElementById('backdrop').classList.remove('show');
      }
    }

    function openModal(id) {
      document.getElementById('backdrop').classList.add('show');
      document.getElementById(id).classList.add('show');
    }

    function openPanel(id) {
      document.getElementById('backdrop').classList.add('show');
      document.getElementById(id).classList.add('open');
    }

    function openAddAssetModal() {
      closeModal('itemTypeModal');
      openModal('addAssetModal');
    }

    function openAddConsumableModal() {
      closeModal('itemTypeModal');
      openModal('addConsumableModal');
    }

    async function showMainApp() {
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('mainHeader').classList.remove('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('userRole').textContent = isAdmin ? 'Admin' : 'Member';

      if (isAdmin) {
        document.getElementById('openManage').style.display = 'flex';
        document.getElementById('addItemBtn').style.display = 'flex';
        document.getElementById('addMemberBtn').style.display = 'flex';
        document.getElementById('exportBtn').style.display = 'flex';
        document.getElementById('syncFromGithubBtn').style.display = 'flex';
      }

      renderAssets();
      renderConsumables();
    }

    async function renderAssets() {
      try {
        const assets = await getAll('assets');
        document.getElementById('assetsCount').textContent = assets.length;
        const tbody = document.getElementById('assetsBody');

        if (!assets.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No assets found</td></tr>';
          return;
        }

        tbody.innerHTML = assets.map(asset => {
          const hasHolder = asset.holder && asset.holder.trim() !== '';
          const statusDisplay = hasHolder ? 'Out' : 'Available';
          const statusClass = hasHolder ? 'badge-orange' : 'badge-green';
          let condDisplay = asset.condition === 'working' ? 'Working' : asset.condition === 'not-working' ? 'Not Working' : 'N/A';

          let actionButtons = '';
          if (isAdmin) {
            actionButtons = `
              <button class="btn-icon" onclick="openEditAssetModal(${asset.id})" title="Edit">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="openAssetHistory(${asset.id})" title="History">üìú</button>
              ${!hasHolder ? `<button class="btn-icon" onclick="openAssignAssetModal(${asset.id})" title="Assign">üì§</button>` : ''}
              ${hasHolder ? `<button class="btn-icon" onclick="openReturnAssetModal(${asset.id})" title="Return">‚Ü©Ô∏è</button>` : ''}
              <button class="btn-icon" onclick="openDeleteModal(${asset.id}, 'assets')" title="Delete">üóëÔ∏è</button>
            `;
          } else {
            actionButtons = `<button class="btn-icon" onclick="openAssetHistory(${asset.id})" title="History">üìú</button>`;
          }

          return `
            <tr>
              <td>${asset.name}</td>
              <td>${asset.serial}</td>
              <td>${asset.holder || '-'}</td>
              <td><span class="badge ${statusClass}">${statusDisplay}</span></td>
              <td><span class="badge ${asset.condition === 'working' ? 'badge-green' : asset.condition === 'not-working' ? 'badge-notworking' : 'badge-orange'}">${condDisplay}</span></td>
              <td><div class="action-buttons">${actionButtons}</div></td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        console.error('Render error:', e);
      }
    }

    async function renderConsumables() {
      try {
        const consumables = await getAll('consumables');
        document.getElementById('consumablesCount').textContent = consumables.length;
        const tbody = document.getElementById('consumablesBody');

        if (!consumables.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No consumables found</td></tr>';
          return;
        }

        tbody.innerHTML = consumables.map(cons => {
          let actionButtons = '';
          if (isAdmin) {
            actionButtons = `
              <button class="btn-icon" onclick="openEditConsumableModal(${cons.id})" title="Edit">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="openAddQuantityModal(${cons.id})" title="Add Qty">‚ûï</button>
              <button class="btn-icon" onclick="openAssignConsumableModal(${cons.id})" title="Assign">üì§</button>
              <button class="btn-icon" onclick="openDeleteModal(${cons.id}, 'consumables')" title="Delete">üóëÔ∏è</button>
            `;
          }

          return `
            <tr>
              <td>${cons.name}</td>
              <td>${cons.partNumber}</td>
              <td><span class="badge badge-green">${cons.quantity}</span></td>
              <td><div class="action-buttons">${actionButtons}</div></td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        console.error('Render error:', e);
      }
    }

    // ========== ASSET FUNCTIONS ==========
    async function openEditAssetModal(assetId) {
      try {
        editingItemId = assetId;
        editingItemType = 'assets';
        const asset = await getOne('assets', assetId);
        
        document.getElementById('editAssetName').value = asset.name;
        document.getElementById('editAssetSerial').value = asset.serial;
        document.getElementById('editAssetCond').value = asset.condition;
        
        openModal('editAssetModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    document.getElementById('editAssetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const asset = await getOne('assets', editingItemId);
        asset.name = document.getElementById('editAssetName').value;
        asset.serial = document.getElementById('editAssetSerial').value;
        asset.condition = document.getElementById('editAssetCond').value;
        
        await updateRecord('assets', asset);
        alert('Asset updated!');
        closeModal('editAssetModal');
        renderAssets();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function openAssignAssetModal(assetId) {
      try {
        const members = await getAll('users');
        const select = document.getElementById('assignAssetMember');
        select.innerHTML = '<option value="">Choose member</option>' + members.map(m => `<option value="${m.id}">${m.name} (${m.email})</option>`).join('');
        select.dataset.assetId = assetId;
        openModal('assignAssetModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    document.getElementById('assignAssetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const assetId = parseInt(document.getElementById('assignAssetMember').dataset.assetId);
        const memberId = parseInt(document.getElementById('assignAssetMember').value);

        if (!memberId) {
          alert('Select a member');
          return;
        }

        const asset = await getOne('assets', assetId);
        const member = await getOne('users', memberId);
        const oldHolder = asset.holder || 'Available';
        asset.holder = member.name;
        
        await updateRecord('assets', asset);

        await addRecord('history', {
          itemId: assetId,
          itemName: asset.name,
          action: 'assigned',
          from: oldHolder,
          to: member.name,
          date: new Date().toLocaleString(),
          user: currentUser.name
        });

        // Send email notification
        await sendEmailNotification(
          member.email,
          `Asset Assigned: ${asset.name}`,
          `Hi ${member.name},\n\nThe asset "${asset.name}" (Serial: ${asset.serial}) has been assigned to you.\n\nRegards,\n${currentUser.name}`
        );

        alert('Asset assigned!');
        closeModal('assignAssetModal');
        renderAssets();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function openReturnAssetModal(assetId) {
      try {
        returningAssetId = assetId;
        const asset = await getOne('assets', assetId);
        document.getElementById('returnAssetInfo').textContent = `Asset: ${asset.name} | Holder: ${asset.holder}`;
        openModal('returnAssetModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function confirmReturnAsset() {
      try {
        const asset = await getOne('assets', returningAssetId);
        const oldHolder = asset.holder;
        asset.holder = '';
        
        await updateRecord('assets', asset);

        await addRecord('history', {
          itemId: returningAssetId,
          itemName: asset.name,
          action: 'returned',
          from: oldHolder,
          to: 'Available',
          date: new Date().toLocaleString(),
          user: currentUser.name
        });

        alert('Asset returned!');
        closeModal('returnAssetModal');
        renderAssets();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function openAssetHistory(assetId) {
      try {
        const allHistory = await getAll('history');
        const itemHistory = allHistory.filter(h => h.itemId === assetId);
        const list = document.getElementById('historyList');

        if (!itemHistory.length) {
          list.innerHTML = '<p style="text-align: center; color: #94a3b8;">No history</p>';
          openModal('historyModal');
          return;
        }

        list.innerHTML = itemHistory.reverse().map(h => `
          <div style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">${h.action.toUpperCase()}</div>
            <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">${h.from} ‚Üí ${h.to}</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">${h.date} by ${h.user}</div>
          </div>
        `).join('');

        openModal('historyModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // ========== CONSUMABLE FUNCTIONS ==========
    async function openEditConsumableModal(consId) {
      try {
        editingItemId = consId;
        editingItemType = 'consumables';
        const cons = await getOne('consumables', consId);
        
        document.getElementById('editConsName').value = cons.name;
        document.getElementById('editConsPartNumber').value = cons.partNumber;
        
        openModal('editConsumableModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    document.getElementById('editConsumableForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const cons = await getOne('consumables', editingItemId);
        cons.name = document.getElementById('editConsName').value;
        cons.partNumber = document.getElementById('editConsPartNumber').value;
        
        await updateRecord('consumables', cons);
        alert('Consumable updated!');
        closeModal('editConsumableModal');
        renderConsumables();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function openAddQuantityModal(consId) {
      try {
        editingItemId = consId;
        const cons = await getOne('consumables', consId);
        document.getElementById('quantityItemName').value = cons.name;
        document.getElementById('quantityToAdd').value = '';
        openModal('addQuantityModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    document.getElementById('addQuantityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const cons = await getOne('consumables', editingItemId);
        const qtyToAdd = parseInt(document.getElementById('quantityToAdd').value);
        
        cons.quantity += qtyToAdd;
        await updateRecord('consumables', cons);
        
        alert(`Added ${qtyToAdd} units!`);
        closeModal('addQuantityModal');
        renderConsumables();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function openAssignConsumableModal(consId) {
      try {
        editingItemId = consId;
        const cons = await getOne('consumables', consId);
        const members = await getAll('users');
        
        document.getElementById('assignConsItemName').value = cons.name;
        document.getElementById('assignConsAvailQty').value = cons.quantity;
        
        const select = document.getElementById('assignConsMember');
        select.innerHTML = '<option value="">Choose member</option>' + members.map(m => `<option value="${m.id}">${m.name} (${m.email})</option>`).join('');
        
        openModal('assignConsumableModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    document.getElementById('assignConsumableForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const memberId = parseInt(document.getElementById('assignConsMember').value);
        const qtyToAssign = parseInt(document.getElementById('assignConsQty').value);

        if (!memberId) {
          alert('Select a member');
          return;
        }

        const cons = await getOne('consumables', editingItemId);
        if (qtyToAssign > cons.quantity) {
          alert('Insufficient quantity!');
          return;
        }

        const member = await getOne('users', memberId);
        
        cons.quantity -= qtyToAssign;
        await updateRecord('consumables', cons);

        await addRecord('history', {
          itemId: editingItemId,
          itemName: cons.name,
          action: 'assigned',
          from: `${cons.quantity + qtyToAssign} units`,
          to: `${member.name} (${qtyToAssign} units)`,
          date: new Date().toLocaleString(),
          user: currentUser.name
        });

        // Send email notification
        await sendEmailNotification(
          member.email,
          `Consumable Item Assigned: ${cons.name}`,
          `Hi ${member.name},\n\nYou have been assigned ${qtyToAssign} unit(s) of "${cons.name}" (Part#: ${cons.partNumber}).\n\nRegards,\n${currentUser.name}`
        );

        alert(`${qtyToAssign} unit(s) assigned to ${member.name}!`);
        closeModal('assignConsumableModal');
        renderConsumables();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    // ========== DELETE MODAL ==========
    function openDeleteModal(itemId, itemType) {
      deletingItemId = itemId;
      deletingItemType = itemType;
      openModal('deleteModal');
    }

    async function confirmDelete() {
      try {
        await deleteRecord(deletingItemType, deletingItemId);
        alert('Item deleted!');
        closeModal('deleteModal');
        
        if (deletingItemType === 'assets') {
          renderAssets();
        } else if (deletingItemType === 'consumables') {
          renderConsumables();
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // ========== ASSET FORM ==========
    document.getElementById('assetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(e.target);
        const asset = {
          name: formData.get('name').trim(),
          serial: formData.get('serial').trim(),
          condition: formData.get('condition'),
          holder: ''
        };

        await addRecord('assets', asset);
        alert('Asset added!');
        e.target.reset();
        closeModal('addAssetModal');
        renderAssets();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    // ========== CONSUMABLE FORM ==========
    document.getElementById('consumableForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(e.target);
        const consumable = {
          name: formData.get('name').trim(),
          partNumber: formData.get('partNumber').trim(),
          quantity: parseInt(formData.get('quantity'))
        };

        await addRecord('consumables', consumable);
        alert('Consumable added!');
        e.target.reset();
        closeModal('addConsumableModal');
        renderConsumables();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    // ========== REGISTRATION & LOGIN ==========
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(e.target);
        const email = formData.get('email').trim().toLowerCase();
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');

        if (password !== confirmPassword) {
          alert('Passwords do not match');
          return;
        }

        if (password.length < 6) {
          alert('Min 6 characters');
          return;
        }

        const users = await getAll('users');
        if (users.some(u => u.email === email)) {
          alert('Email already registered');
          return;
        }

        const user = {
          name: formData.get('name').trim(),
          email: email,
          password: btoa(password),
          mobile: formData.get('mobile').trim() || '',
          designation: formData.get('designation').trim() || '',
          department: formData.get('department').trim() || '',
          isAdmin: users.length === 0
        };

        const userId = await addRecord('users', user);
        user.id = userId;
        currentUser = user;
        isAdmin = user.isAdmin;

        alert('Account created!');
        showMainApp();
        e.target.reset();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(e.target);
        const email = formData.get('email').trim().toLowerCase();
        const password = btoa(formData.get('password'));

        const users = await getAll('users');
        const user = users.find(u => u.email === email && u.password === password);

        if (!user) {
          alert('Invalid email or password');
          return;
        }

        currentUser = user;
        isAdmin = user.isAdmin || false;
        showMainApp();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    // ========== SETTINGS ==========
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      closePanel('settingsPanel');
      document.getElementById('editName').value = currentUser.name;
      document.getElementById('editEmail').value = currentUser.email;
      document.getElementById('editMobile').value = currentUser.mobile || '';
      document.getElementById('editDesignation').value = currentUser.designation || '';
      document.getElementById('editDepartment').value = currentUser.department || '';
      openModal('editProfileModal');
    });

    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        currentUser.name = document.getElementById('editName').value.trim();
        currentUser.email = document.getElementById('editEmail').value.trim();
        currentUser.mobile = document.getElementById('editMobile').value.trim();
        currentUser.designation = document.getElementById('editDesignation').value.trim();
        currentUser.department = document.getElementById('editDepartment').value.trim();

        await updateRecord('users', currentUser);
        alert('Profile updated!');
        closeModal('editProfileModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      closePanel('settingsPanel');
      openModal('changePasswordModal');
    });

    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const currentPassword = btoa(document.getElementById('currentPassword').value);
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;

        if (currentPassword !== currentUser.password) {
          alert('Wrong password');
          return;
        }

        if (newPassword !== confirmPassword) {
          alert('Passwords do not match');
          return;
        }

        if (newPassword.length < 6) {
          alert('Min 6 characters');
          return;
        }

        currentUser.password = btoa(newPassword);
        await updateRecord('users', currentUser);
        alert('Password changed!');
        document.getElementById('changePasswordForm').reset();
        closeModal('changePasswordModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      closePanel('settingsPanel');
      currentUser = null;
      isAdmin = false;
      document.getElementById('authScreen').classList.remove('hidden');
      document.getElementById('mainHeader').classList.add('hidden');
      document.getElementById('mainContent').classList.add('hidden');
    });

    document.getElementById('addItemBtn').addEventListener('click', () => {
      closePanel('managePanel');
      openModal('itemTypeModal');
    });

    document.getElementById('addMemberBtn').addEventListener('click', () => {
      closePanel('managePanel');
      openModal('addMemberModal');
    });

    document.getElementById('memberForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(e.target);
        const email = formData.get('email').trim().toLowerCase();
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');

        if (password !== confirmPassword) {
          alert('Passwords do not match');
          return;
        }

        if (password.length < 6) {
          alert('Min 6 characters');
          return;
        }

        const users = await getAll('users');
        if (users.some(u => u.email === email)) {
          alert('Email exists');
          return;
        }

        const user = {
          name: formData.get('name').trim(),
          email: email,
          password: btoa(password),
          mobile: formData.get('mobile').trim() || '',
          designation: formData.get('designation').trim() || '',
          department: formData.get('department').trim() || '',
          isAdmin: false
        };

        await addRecord('users', user);
        alert('Member added!');
        e.target.reset();
        closeModal('addMemberModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    document.getElementById('viewMembersBtn').addEventListener('click', async () => {
      closePanel('managePanel');
      try {
        const users = await getAll('users');
        const list = document.getElementById('membersList');

        if (!users.length) {
          list.innerHTML = '<p style="text-align: center; color: #94a3b8;">No members</p>';
          openModal('membersModal');
          return;
        }

        list.innerHTML = users.map(u => `
          <div style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; margin-bottom: 1rem;">
            <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem;">${u.name}</div>
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">${u.email}</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">${u.designation || 'N/A'} - ${u.department || 'N/A'}</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">${u.isAdmin ? 'Admin' : 'Member'}</div>
          </div>
        `).join('');

        openModal('membersModal');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    // ========== THEME ==========
    document.getElementById('lightBtn').addEventListener('click', () => {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('theme', 'light');
      document.getElementById('lightBtn').classList.add('active');
      document.getElementById('darkBtn').classList.remove('active');
    });

    document.getElementById('darkBtn').addEventListener('click', () => {
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
      document.getElementById('darkBtn').classList.add('active');
      document.getElementById('lightBtn').classList.remove('active');
    });

    // ========== PANELS ==========
    document.getElementById('openManage').addEventListener('click', () => openPanel('managePanel'));
    document.getElementById('closeManage').addEventListener('click', () => closePanel('managePanel'));
    document.getElementById('settingsBtn').addEventListener('click', () => openPanel('settingsPanel'));
    document.getElementById('closeSettings').addEventListener('click', () => closePanel('settingsPanel'));

    document.getElementById('backdrop').addEventListener('click', () => {
      closePanel('managePanel');
      closePanel('settingsPanel');
      document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show'));
      document.getElementById('backdrop').classList.remove('show');
    });

    document.getElementById('viewItemsBtn').addEventListener('click', () => {
      closePanel('managePanel');
      switchTab('assets');
    });

    // ========== STARTUP ==========
    (async () => {
      try {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark');
        }

        await initDB();
        console.log('‚úì Database ready');
        await autoSyncFromGithub();
        console.log('‚úì App ready!');
      } catch (e) {
        console.error('Error:', e.message);
        alert('Error: ' + e.message);
      }
    })();
  </script>
</body>
</html>