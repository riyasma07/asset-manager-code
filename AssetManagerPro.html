<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f0f0; }
        
        .container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 10px; padding: 40px; width: 100%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .card h1 { text-align: center; font-size: 28px; color: #333; margin-bottom: 10px; }
        .card p { text-align: center; color: #888; font-size: 14px; margin-bottom: 30px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 5px; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        
        .btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-small { padding: 6px 12px; font-size: 12px; margin-right: 5px; }
        .link { text-align: center; margin-top: 15px; font-size: 14px; }
        .link a { color: #667eea; cursor: pointer; text-decoration: none; font-weight: 600; }
        .link a:hover { text-decoration: underline; }
        
        .hidden { display: none !important; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .header .right { display: flex; gap: 15px; align-items: center; }
        
        .app { display: flex; min-height: 100vh; background: white; }
        .sidebar { width: 200px; background: #f8f8f8; border-right: 1px solid #ddd; padding: 20px; }
        .menu-group { margin-bottom: 20px; }
        .menu-title { font-size: 12px; font-weight: 700; color: #999; text-transform: uppercase; margin-bottom: 10px; }
        .menu-item { padding: 10px; cursor: pointer; border-radius: 5px; color: #333; font-size: 14px; margin-bottom: 5px; transition: 0.2s; }
        .menu-item:hover { background: #e0e0e0; }
        .menu-item.active { background: #667eea; color: white; font-weight: 600; }
        
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .title { font-size: 28px; color: #333; margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        thead { background: #f8f8f8; border-bottom: 2px solid #ddd; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #333; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; color: #333; font-size: 14px; }
        tr:hover { background: #f9f9f9; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-working { background: #dcfce7; color: #166534; }
        .badge-notworking { background: #fee2e2; color: #991b1b; }
        .badge-na { background: #fed7aa; color: #b45309; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; color: #333; }
        .close { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel { background: #e0e0e0; color: #333; padding: 10px 20px; }
        
        .alert { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .alert.active { display: flex; }
        .alert-box { background: white; border-radius: 10px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .alert-icon { font-size: 48px; margin-bottom: 15px; }
        .alert-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .alert-message { color: #666; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            .app { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth" class="container">
    <!-- LOGIN -->
    <div id="loginCard" class="card hidden">
        <h1>üîê Asset Manager Pro</h1>
        <p>Professional Inventory System</p>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn">üîì Sign In</button>
            <div class="link">New user? Ask your admin to add you.</div>
        </form>
    </div>

    <!-- SETUP -->
    <div id="setupCard" class="card hidden">
        <h1>üîß First Time Setup</h1>
        <p>You will be the admin</p>
        <form onsubmit="handleSetup(event)">
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="setupFullName" required>
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="setupEmail" required>
            </div>
            <div class="form-group">
                <label>Mobile</label>
                <input type="tel" id="setupMobile">
            </div>
            <div class="form-group">
                <label>Designation</label>
                <input type="text" id="setupDesignation">
            </div>
            <div class="form-group">
                <label>Department</label>
                <input type="text" id="setupDepartment">
            </div>
            <div class="form-group">
                <label>Password * (Min 6)</label>
                <input type="password" id="setupPassword" required minlength="6">
            </div>
            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="password" id="setupConfirmPassword" required>
            </div>
            <button type="submit" class="btn">üëë Create Admin Account</button>
            <div class="link"><a onclick="toggleAuth()">Already registered? Sign In</a></div>
        </form>
    </div>
</div>

<!-- APP SCREEN -->
<div id="appScreen" class="hidden">
    <div class="header">
        <h1 id="pageTitle">üì¶ Inventory Items</h1>
        <div class="right">
            <span id="userName">User</span>
            <button class="btn btn-small" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="menu-group">
                <div class="menu-title">üìã Menu</div>
                <div class="menu-item active" onclick="showPage('items')">üì¶ View Items</div>
                <div class="menu-item" onclick="showPage('addItem')">‚ûï Add Item</div>
                <div class="menu-item" onclick="showPage('members')">üë• View Members</div>
                <div class="menu-item" onclick="showPage('addMember')">üë§ Add Member</div>
            </div>
            <div class="menu-group">
                <div class="menu-title">‚öôÔ∏è Settings</div>
                <div class="menu-item" onclick="editProfile()">‚úèÔ∏è Edit Profile</div>
                <div class="menu-item" onclick="changePassword()">üîê Change Password</div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main">
            <!-- ITEMS PAGE -->
            <div id="itemsPage">
                <div class="title">üì¶ Inventory Items</div>
                <button class="btn" style="width: auto; margin-bottom: 20px;" onclick="openModal('addItemModal')">‚ûï Add Item</button>
                <p style="margin-bottom: 15px; color: #666;">Total Items: <strong id="itemCount">0</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Serial Number</th>
                            <th>Holder</th>
                            <th>Condition</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #999;">No items found</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ADD ITEM PAGE -->
            <div id="addItemPage" class="hidden">
                <div class="title">‚ûï Add Item</div>
                <div style="max-width: 500px;">
                    <form onsubmit="handleAddItem(event)">
                        <div class="form-group">
                            <label>Item Name *</label>
                            <input type="text" id="formItemName" required>
                        </div>
                        <div class="form-group">
                            <label>Serial Number *</label>
                            <input type="text" id="formItemSerial" required>
                        </div>
                        <div class="form-group">
                            <label>Condition *</label>
                            <select id="formItemCondition" required>
                                <option value="">Select Condition</option>
                                <option value="‚úì Working">‚úì Working</option>
                                <option value="‚úó Not Working">‚úó Not Working</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-cancel" onclick="showPage('items')">Cancel</button>
                            <button type="submit" class="btn">Add Item</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- MEMBERS PAGE -->
            <div id="membersPage" class="hidden">
                <div class="title">üë• Members</div>
                <button class="btn" style="width: auto; margin-bottom: 20px;" onclick="showPage('addMember')">üë§ Add Member</button>
                <p style="margin-bottom: 15px; color: #666;">Total Members: <strong id="memberCount">0</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>Designation</th>
                            <th>Department</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #999;">No members found</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ADD MEMBER PAGE -->
            <div id="addMemberPage" class="hidden">
                <div class="title">üë§ Add Member</div>
                <div style="max-width: 500px;">
                    <form onsubmit="handleAddMember(event)">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="formMemberName" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="formMemberEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" id="formMemberMobile">
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" id="formMemberDesignation">
                        </div>
                        <div class="form-group">
                            <label>Department</label>
                            <input type="text" id="formMemberDepartment">
                        </div>
                        <div class="form-group">
                            <label>Password * (Min 6)</label>
                            <input type="password" id="formMemberPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password *</label>
                            <input type="password" id="formMemberConfirmPassword" required>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-cancel" onclick="showPage('members')">Cancel</button>
                            <button type="submit" class="btn">Add Member</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADD ITEM MODAL -->
<div id="addItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Add Item</h2>
            <button class="close" onclick="closeModal('addItemModal')">√ó</button>
        </div>
        <form onsubmit="handleAddItemModal(event)">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="modalItemName" required>
            </div>
            <div class="form-group">
                <label>Serial Number *</label>
                <input type="text" id="modalItemSerial" required>
            </div>
            <div class="form-group">
                <label>Condition *</label>
                <select id="modalItemCondition" required>
                    <option value="">Select Condition</option>
                    <option value="‚úì Working">‚úì Working</option>
                    <option value="‚úó Not Working">‚úó Not Working</option>
                    <option value="N/A">N/A</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal('addItemModal')">Cancel</button>
                <button type="submit" class="btn">Add Item</button>
            </div>
        </form>
    </div>
</div>

<!-- ASSIGN MODAL -->
<div id="assignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì§ Assign Item</h2>
            <button class="close" onclick="closeModal('assignModal')">√ó</button>
        </div>
        <form onsubmit="handleAssign(event)">
            <div class="form-group">
                <label>Select Member *</label>
                <select id="assignMemberSelect" required>
                    <option value="">Choose member</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal('assignModal')">Cancel</button>
                <button type="submit" class="btn">Assign</button>
            </div>
        </form>
    </div>
</div>

<!-- NOTIFY MODAL -->
<div id="notifyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìß Send Notification</h2>
            <button class="close" onclick="closeModal('notifyModal')">√ó</button>
        </div>
        <p id="notifyMessage" style="margin: 15px 0; color: #666;"></p>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('notifyModal')">Cancel</button>
            <button type="button" class="btn" onclick="confirmNotify()">Send</button>
        </div>
    </div>
</div>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üóëÔ∏è Delete Item</h2>
            <button class="close" onclick="closeModal('deleteModal')">√ó</button>
        </div>
        <p style="margin: 15px 0; color: #666;">This action cannot be undone. Are you sure?</p>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button type="button" class="btn" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<!-- ALERT -->
<div id="alert" class="alert">
    <div class="alert-box">
        <div class="alert-icon" id="alertIcon"></div>
        <div class="alert-title" id="alertTitle"></div>
        <div class="alert-message" id="alertMessage"></div>
        <button class="btn" onclick="closeAlert()" style="margin-top: 15px;">OK</button>
    </div>
</div>

<script>
    let allItems = { items: [], members: [], emails: [] };
    let currentUser = null;
    let appInitialized = false;
    let pendingDeleteIdx = null;
    let pendingAssignIdx = null;
    let pendingNotifyIdx = null;

    // Wait for loader data
    function waitForData() {
        if (typeof window.assetManagerData !== 'undefined') {
            allItems = window.assetManagerData;
            console.log('‚úì Data loaded:', allItems);
            initializeApp();
        } else if (!appInitialized) {
            setTimeout(waitForData, 300);
        }
    }

    function initializeApp() {
        if (appInitialized) return;
        appInitialized = true;

        if (!allItems.members || allItems.members.length === 0) {
            document.getElementById('setupCard').classList.remove('hidden');
            document.getElementById('loginCard').classList.add('hidden');
        } else {
            document.getElementById('loginCard').classList.remove('hidden');
            document.getElementById('setupCard').classList.add('hidden');
        }
    }

    function toggleAuth() {
        document.getElementById('loginCard').classList.toggle('hidden');
        document.getElementById('setupCard').classList.toggle('hidden');
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const pwd = document.getElementById('loginPassword').value;
        const user = allItems.members && allItems.members.find(m => m && m.email === email && m.password === pwd);
        if (!user) {
            await showAlert('‚ùå Error', 'Invalid credentials', 'error');
            return;
        }
        currentUser = user;
        showApp();
    }

    async function handleSetup(e) {
        e.preventDefault();
        const pwd = document.getElementById('setupPassword').value;
        const confirm = document.getElementById('setupConfirmPassword').value;
        if (pwd !== confirm) {
            await showAlert('‚ùå Error', 'Passwords do not match', 'error');
            return;
        }

        const admin = {
            id: Date.now(),
            fullName: document.getElementById('setupFullName').value,
            email: document.getElementById('setupEmail').value,
            password: pwd,
            mobile: document.getElementById('setupMobile').value,
            designation: document.getElementById('setupDesignation').value,
            department: document.getElementById('setupDepartment').value,
            role: 'admin',
            createdDate: new Date().toISOString()
        };

        if (!allItems.members) allItems.members = [];
        allItems.members.push(admin);
        currentUser = admin;
        window.saveData(allItems);
        await showAlert('‚úÖ Success', 'Admin created!', 'success');
        location.reload();
    }

    function showApp() {
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.fullName;
        showPage('items');
    }

    function logout() {
        currentUser = null;
        document.getElementById('auth').classList.remove('hidden');
        document.getElementById('appScreen').classList.add('hidden');
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
    }

    function showPage(page) {
        document.querySelectorAll('[id$="Page"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));

        if (page === 'items') {
            document.getElementById('itemsPage').classList.remove('hidden');
            document.getElementById('pageTitle').textContent = 'üì¶ Inventory Items';
            document.querySelectorAll('.menu-item')[0].classList.add('active');
            displayItems();
        } else if (page === 'addItem') {
            document.getElementById('addItemPage').classList.remove('hidden');
            document.getElementById('pageTitle').textContent = '‚ûï Add Item';
            document.querySelectorAll('.menu-item')[1].classList.add('active');
        } else if (page === 'members') {
            document.getElementById('membersPage').classList.remove('hidden');
            document.getElementById('pageTitle').textContent = 'üë• Members';
            document.querySelectorAll('.menu-item')[2].classList.add('active');
            displayMembers();
        } else if (page === 'addMember') {
            document.getElementById('addMemberPage').classList.remove('hidden');
            document.getElementById('pageTitle').textContent = 'üë§ Add Member';
            document.querySelectorAll('.menu-item')[3].classList.add('active');
        }
    }

    function displayItems() {
        const tbody = document.getElementById('itemsTableBody');
        document.getElementById('itemCount').textContent = allItems.items ? allItems.items.length : 0;

        if (!allItems.items || allItems.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No items found</td></tr>';
            return;
        }

        tbody.innerHTML = allItems.items.map((item, idx) => {
            const holder = allItems.members && allItems.members.find(m => m && m.id === item.assignedTo);
            const badgeClass = item.condition.includes('Working') && !item.condition.includes('Not') ? 'badge-working' : 
                             item.condition.includes('Not') ? 'badge-notworking' : 'badge-na';

            return `<tr>
                <td>${item.name}</td>
                <td>${item.serialNumber}</td>
                <td>${holder ? holder.fullName : 'Unassigned'}</td>
                <td><span class="badge ${badgeClass}">${item.condition}</span></td>
                <td>
                    <button class="btn btn-small" onclick="openAssignModal(${idx})">üì§</button>
                    ${item.assignedTo ? `<button class="btn btn-small" onclick="openNotifyModal(${idx})">üîî</button>` : ''}
                    <button class="btn btn-small" onclick="openDeleteModal(${idx})">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    function displayMembers() {
        const tbody = document.getElementById('membersTableBody');
        document.getElementById('memberCount').textContent = allItems.members ? allItems.members.length : 0;

        if (!allItems.members || allItems.members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No members found</td></tr>';
            return;
        }

        tbody.innerHTML = allItems.members.map(m => `<tr>
            <td>${m.fullName}</td>
            <td>${m.email}</td>
            <td>${m.mobile || '-'}</td>
            <td>${m.designation || '-'}</td>
            <td>${m.department || '-'}</td>
        </tr>`).join('');
    }

    async function handleAddItemModal(e) {
        e.preventDefault();
        const item = {
            id: Date.now(),
            name: document.getElementById('modalItemName').value,
            serialNumber: document.getElementById('modalItemSerial').value,
            condition: document.getElementById('modalItemCondition').value,
            assignedTo: null,
            createdDate: new Date().toISOString()
        };

        if (!allItems.items) allItems.items = [];
        allItems.items.push(item);
        window.saveData(allItems);
        closeModal('addItemModal');
        displayItems();
        await showAlert('‚úÖ Success', 'Item added!', 'success');
    }

    async function handleAddItem(e) {
        e.preventDefault();
        const item = {
            id: Date.now(),
            name: document.getElementById('formItemName').value,
            serialNumber: document.getElementById('formItemSerial').value,
            condition: document.getElementById('formItemCondition').value,
            assignedTo: null,
            createdDate: new Date().toISOString()
        };

        if (!allItems.items) allItems.items = [];
        allItems.items.push(item);
        window.saveData(allItems);

        showPage('items');
        await showAlert('‚úÖ Success', 'Item added!', 'success');
    }

    function openAssignModal(idx) {
        pendingAssignIdx = idx;
        const select = document.getElementById('assignMemberSelect');
        select.innerHTML = '<option value="">Choose member</option>';
        allItems.members.forEach((m, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = `${m.fullName} (${m.email})`;
            select.appendChild(opt);
        });
        openModal('assignModal');
    }

    async function handleAssign(e) {
        e.preventDefault();
        const memberIdx = parseInt(document.getElementById('assignMemberSelect').value);
        if (isNaN(memberIdx)) {
            await showAlert('‚ùå Error', 'Select a member', 'error');
            return;
        }

        allItems.items[pendingAssignIdx].assignedTo = allItems.members[memberIdx].id;
        window.saveData(allItems);
        closeModal('assignModal');
        displayItems();
        await showAlert('‚úÖ Success', 'Item assigned!', 'success');
    }

    function openDeleteModal(idx) {
        pendingDeleteIdx = idx;
        openModal('deleteModal');
    }

    async function confirmDelete() {
        allItems.items.splice(pendingDeleteIdx, 1);
        window.saveData(allItems);
        closeModal('deleteModal');
        displayItems();
        await showAlert('‚úÖ Success', 'Item deleted!', 'success');
    }

    function openNotifyModal(idx) {
        pendingNotifyIdx = idx;
        const item = allItems.items[idx];
        const member = allItems.members.find(m => m && m.id === item.assignedTo);
        document.getElementById('notifyMessage').textContent = `Send notification to ${member.fullName} at ${member.email}?`;
        openModal('notifyModal');
    }

    async function confirmNotify() {
        const item = allItems.items[pendingNotifyIdx];
        const member = allItems.members.find(m => m && m.id === item.assignedTo);

        if (!allItems.emails) allItems.emails = [];
        allItems.emails.push({
            type: 'ITEM_ASSIGNMENT',
            recipient: member.email,
            subject: `Item Assigned: ${item.name}`,
            body: `Item assigned. Condition: ${item.condition}`,
            timestamp: new Date().toISOString(),
            status: 'pending'
        });

        window.saveData(allItems);
        closeModal('notifyModal');
        await showAlert('‚úÖ Success', 'Notification queued!', 'success');
    }

    async function handleAddMember(e) {
        e.preventDefault();
        const pwd = document.getElementById('formMemberPassword').value;
        const confirm = document.getElementById('formMemberConfirmPassword').value;

        if (pwd !== confirm) {
            await showAlert('‚ùå Error', 'Passwords do not match', 'error');
            return;
        }

        const member = {
            id: Date.now(),
            fullName: document.getElementById('formMemberName').value,
            email: document.getElementById('formMemberEmail').value,
            password: pwd,
            mobile: document.getElementById('formMemberMobile').value,
            designation: document.getElementById('formMemberDesignation').value,
            department: document.getElementById('formMemberDepartment').value,
            role: 'member',
            createdDate: new Date().toISOString()
        };

        if (!allItems.members) allItems.members = [];
        allItems.members.push(member);
        window.saveData(allItems);

        const sendEmail = await confirmDialog('üìß Send Email?', `Send credentials to ${member.email}?`);

        if (sendEmail) {
            if (!allItems.emails) allItems.emails = [];
            allItems.emails.push({
                type: 'WELCOME_EMAIL',
                recipient: member.email,
                subject: 'Asset Manager Pro - Account Created',
                body: `Email: ${member.email}\nPassword: ${pwd}`,
                timestamp: new Date().toISOString(),
                status: 'pending'
            });
            window.saveData(allItems);
            await showAlert('‚úÖ Success', 'Member added & email sent!', 'success');
        } else {
            await showAlert('‚úÖ Success', 'Member added!', 'success');
        }

        showPage('members');
    }

    async function editProfile() {
        await showAlert('üë§ Profile', `Edit ${currentUser.fullName}'s profile`, 'info');
    }

    async function changePassword() {
        await showAlert('üîê Password', 'Feature coming soon', 'info');
    }

    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    async function showAlert(title, message, type) {
        return new Promise(resolve => {
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            document.getElementById('alertIcon').textContent = icons[type] || '‚Ñπ';
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            window.alertResolve = resolve;
            document.getElementById('alert').classList.add('active');
        });
    }

    function closeAlert() {
        document.getElementById('alert').classList.remove('active');
        if (window.alertResolve) window.alertResolve();
    }

    async function confirmDialog(title, message) {
        return new Promise(resolve => {
            document.getElementById('alertIcon').textContent = '‚ùì';
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            window.alertResolve = resolve;
            document.getElementById('alert').classList.add('active');
        });
    }

    // Start
    waitForData();
</script>

</body>
</html>