<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ==================== BEAUTIFUL CONFIRMATION DIALOG ==================== */
        .beautiful-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .beautiful-overlay.active {
            display: flex;
        }

        .beautiful-dialog {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
        }

        .beautiful-icon {
            font-size: 64px;
            margin-bottom: 20px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beautiful-icon.success { color: #10b981; }
        .beautiful-icon.error { color: #ef4444; }
        .beautiful-icon.warning { color: #f59e0b; }
        .beautiful-icon.info { color: #3b82f6; }

        .beautiful-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .beautiful-message {
            color: #6b7280;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .beautiful-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .beautiful-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            font-size: 14px;
        }

        .beautiful-btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }

        .beautiful-btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .beautiful-btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .beautiful-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .beautiful-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .beautiful-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* ==================== AUTH CONTAINER ==================== */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-box {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #6b7280;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn-auth {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: #6b7280;
            font-size: 14px;
        }

        .auth-footer a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* ==================== MAIN APP ==================== */
        .app-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: white;
        }

        .app-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            overflow-y: auto;
        }

        .sidebar-logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }

        .menu-section {
            margin-bottom: 30px;
        }

        .menu-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .menu-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .main-content {
            padding: 40px;
            overflow-y: auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .top-bar h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #6b7280;
            font-weight: 600;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* ==================== ITEMS TABLE ==================== */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .items-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .items-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .items-table td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
            color: #374151;
        }

        .items-table tr:hover {
            background: #f9fafb;
        }

        /* ==================== CONDITION BADGES ==================== */
        .condition-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            display: inline-block;
        }

        .condition-working {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .condition-notworking {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .condition-na {
            background-color: #fed7aa;
            color: #b45309;
            border: 1px solid #fdba74;
        }

        /* ==================== ACTION BUTTONS ==================== */
        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-right: 6px;
            transition: all 0.2s ease;
        }

        .btn-assign {
            background: #667eea;
            color: white;
        }

        .btn-assign:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-notify {
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
        }

        .btn-notify:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ==================== MODAL ==================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s ease;
            background: none;
            border: none;
        }

        .close:hover {
            color: #374151;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-cancel {
            padding: 12px 24px;
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .btn-confirm {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* ==================== BUTTON GROUP ==================== */
        .button-group {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .button-group button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .app-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .main-content {
                padding: 20px;
            }

            .top-bar {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- BEAUTIFUL CONFIRMATION DIALOG -->
<div id="confirmDialog" class="beautiful-overlay">
    <div class="beautiful-dialog">
        <div class="beautiful-icon" id="confirmIcon"></div>
        <div class="beautiful-title" id="confirmTitle"></div>
        <div class="beautiful-message" id="confirmMessage"></div>
        <div class="beautiful-buttons">
            <button class="beautiful-btn beautiful-btn-cancel" onclick="closeConfirm(false)">Cancel</button>
            <button class="beautiful-btn beautiful-btn-confirm" id="confirmBtn" onclick="closeConfirm(true)">Confirm</button>
        </div>
    </div>
</div>

<!-- ALERT DIALOG -->
<div id="alertDialog" class="beautiful-overlay">
    <div class="beautiful-dialog">
        <div class="beautiful-icon" id="alertIcon"></div>
        <div class="beautiful-title" id="alertTitle"></div>
        <div class="beautiful-message" id="alertMessage"></div>
        <div class="beautiful-buttons">
            <button class="beautiful-btn beautiful-btn-primary" onclick="closeAlert()">OK</button>
        </div>
    </div>
</div>

<!-- AUTH CONTAINER -->
<div id="authContainer" class="auth-container">
    <!-- LOGIN FORM -->
    <div id="loginForm" class="auth-box" style="display: none;">
        <div class="auth-header">
            <h1>üîê Asset Manager Pro</h1>
            <p>Professional Inventory System</p>
        </div>

        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" required>
            </div>

            <button type="submit" class="btn-auth">üîì Sign In</button>
        </form>

        <div class="auth-footer">
            New user? Ask your admin to add you.
        </div>
    </div>

    <!-- SETUP FORM -->
    <div id="setupForm" class="auth-box" style="display: none;">
        <div class="auth-header">
            <h1>üîß First Time Setup</h1>
            <p>You will be the admin</p>
        </div>

        <form onsubmit="handleSetup(event)">
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="setupFullName" placeholder="Your name" required>
            </div>

            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="setupEmail" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
                <label>Mobile</label>
                <input type="tel" id="setupMobile" placeholder="Phone number">
            </div>

            <div class="form-group">
                <label>Designation</label>
                <input type="text" id="setupDesignation" placeholder="Your designation">
            </div>

            <div class="form-group">
                <label>Department</label>
                <input type="text" id="setupDepartment" placeholder="Your department">
            </div>

            <div class="form-group">
                <label>Password * (Min 6)</label>
                <input type="password" id="setupPassword" placeholder="Min 6 characters" required minlength="6">
            </div>

            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="password" id="setupConfirmPassword" placeholder="Confirm password" required>
            </div>

            <button type="submit" class="btn-auth">üëë Create Admin Account</button>
        </form>

        <div class="auth-footer">
            Already registered? <a onclick="showLogin()">Sign In</a>
        </div>
    </div>
</div>

<!-- MAIN APPLICATION -->
<div id="mainApp" class="app-container">
    <div class="app-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-logo">üì¶ AMP</div>

            <div class="menu-section">
                <div class="menu-title">üìã Menu</div>
                <div class="menu-item active" onclick="showViewItems()">
                    <i class="fas fa-list"></i> View Items
                </div>
                <div class="menu-item" onclick="showAddItem()">
                    <i class="fas fa-plus"></i> Add Item
                </div>
                <div class="menu-item" onclick="showViewMembers()">
                    <i class="fas fa-users"></i> View Members
                </div>
                <div class="menu-item" onclick="showAddMember()">
                    <i class="fas fa-user-plus"></i> Add Member
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">‚öôÔ∏è Settings</div>
                <div class="menu-item" onclick="editProfile()">
                    <i class="fas fa-edit"></i> Edit Profile
                </div>
                <div class="menu-item" onclick="changePassword()">
                    <i class="fas fa-lock"></i> Change Password
                </div>
                <div class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-bar">
                <h1 id="pageTitle">üì¶ Inventory Items</h1>
                <div class="user-section">
                    <span class="user-name">üë§ <span id="userDisplay"></span></span>
                </div>
            </div>

            <!-- VIEW ITEMS PAGE -->
            <div id="viewItemsPage">
                <div class="button-group">
                    <button onclick="openAddItemModal()">‚ûï Add Item</button>
                </div>

                <p style="color: #6b7280; margin-bottom: 15px;">Total Items: <strong id="itemCount">0</strong></p>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Serial Number</th>
                            <th>Holder</th>
                            <th>Condition</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #9ca3af;">No items found</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ADD ITEM PAGE -->
            <div id="addItemPage" style="display: none;">
                <form onsubmit="handleAddItemForm(event)">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" id="formItemName" placeholder="Enter item name" required>
                    </div>

                    <div class="form-group">
                        <label>Serial Number *</label>
                        <input type="text" id="formItemSerial" placeholder="Enter serial number" required>
                    </div>

                    <div class="form-group">
                        <label>Condition *</label>
                        <select id="formItemCondition" required>
                            <option value="">Select Condition</option>
                            <option value="‚úì Working">‚úì Working</option>
                            <option value="‚úó Not Working">‚úó Not Working</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" onclick="showViewItems()">Cancel</button>
                        <button type="submit" class="btn-confirm">Add Item</button>
                    </div>
                </form>
            </div>

            <!-- MEMBERS PAGE -->
            <div id="membersPage" style="display: none;">
                <div class="button-group">
                    <button onclick="showAddMember()">üë§ Add Member</button>
                </div>

                <p style="color: #6b7280; margin-bottom: 15px;">Total Members: <strong id="memberCount">0</strong></p>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>Designation</th>
                            <th>Department</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #9ca3af;">No members found</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ADD MEMBER PAGE -->
            <div id="addMemberPage" style="display: none;">
                <form onsubmit="handleAddMemberForm(event)">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="formMemberName" placeholder="Enter name" required>
                    </div>

                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="formMemberEmail" placeholder="Enter email" required>
                    </div>

                    <div class="form-group">
                        <label>Mobile</label>
                        <input type="tel" id="formMemberMobile" placeholder="Phone number">
                    </div>

                    <div class="form-group">
                        <label>Designation</label>
                        <input type="text" id="formMemberDesignation" placeholder="Designation">
                    </div>

                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="formMemberDepartment" placeholder="Department">
                    </div>

                    <div class="form-group">
                        <label>Password * (Min 6)</label>
                        <input type="password" id="formMemberPassword" placeholder="Min 6 characters" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" id="formMemberConfirmPassword" placeholder="Confirm password" required>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" onclick="showViewMembers()">Cancel</button>
                        <button type="submit" class="btn-confirm">Add Member</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ADD ITEM MODAL -->
<div id="addItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Add Item</h2>
            <button class="close" onclick="closeModal('addItemModal')">&times;</button>
        </div>

        <form onsubmit="handleAddItem(event)">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="itemName" placeholder="Enter item name" required>
            </div>

            <div class="form-group">
                <label>Serial Number *</label>
                <input type="text" id="itemSerial" placeholder="Enter serial number" required>
            </div>

            <div class="form-group">
                <label>Condition *</label>
                <select id="itemCondition" required>
                    <option value="">Select Condition</option>
                    <option value="‚úì Working">‚úì Working</option>
                    <option value="‚úó Not Working">‚úó Not Working</option>
                    <option value="N/A">N/A</option>
                </select>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('addItemModal')">Cancel</button>
                <button type="submit" class="btn-confirm">Add Item</button>
            </div>
        </form>
    </div>
</div>

<!-- ASSIGN ITEM MODAL -->
<div id="assignItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì§ Assign Item</h2>
            <button class="close" onclick="closeModal('assignItemModal')">&times;</button>
        </div>

        <form onsubmit="handleAssignItem(event)">
            <div class="form-group">
                <label>Select Member *</label>
                <select id="assignMember" required>
                    <option value="">Choose member</option>
                </select>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('assignItemModal')">Cancel</button>
                <button type="submit" class="btn-confirm">Assign</button>
            </div>
        </form>
    </div>
</div>

<!-- DELETE ITEM MODAL -->
<div id="deleteItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üóëÔ∏è Delete Item</h2>
            <button class="close" onclick="closeModal('deleteItemModal')">&times;</button>
        </div>

        <p style="color: #6b7280; margin-bottom: 24px;">This action cannot be undone. Are you sure?</p>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal('deleteItemModal')">Cancel</button>
            <button type="button" class="btn-confirm" onclick="confirmDeleteItem()">Delete</button>
        </div>
    </div>
</div>

<script>
    // ==================== DATA & STATE ====================
    let allItems = { items: [], members: [], emails: [] };
    let currentUser = null;
    let currentPage = 'viewItems';
    let pendingDeleteIndex = null;
    let pendingAssignIndex = null;
    let confirmCallback = null;
    let appInitialized = false;

    // ==================== WAIT FOR LOADER INJECTION ====================
    // This function waits for window.assetManagerData to be injected by the loader
    function waitForLoaderData() {
        if (typeof window.assetManagerData !== 'undefined' && window.assetManagerData !== null) {
            // Data is ready! Use it
            allItems = window.assetManagerData || { items: [], members: [], emails: [] };
            console.log('‚úì Data injected by loader:', allItems);
            initializeApp();
        } else if (!appInitialized) {
            // Data not ready yet, wait and try again
            console.log('Waiting for loader to inject data...');
            setTimeout(waitForLoaderData, 500);
        }
    }

    // ==================== DIALOG FUNCTIONS ==================== 
    async function showConfirm(title, message, type = 'warning') {
        return new Promise(resolve => {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const iconMap = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            document.getElementById('confirmIcon').textContent = iconMap[type];
            document.getElementById('confirmIcon').className = `beautiful-icon ${type}`;
            
            confirmCallback = resolve;
            document.getElementById('confirmDialog').classList.add('active');
        });
    }

    function closeConfirm(result) {
        document.getElementById('confirmDialog').classList.remove('active');
        if (confirmCallback) confirmCallback(result);
    }

    async function showAlert(title, message, type = 'info') {
        return new Promise(resolve => {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            
            const iconMap = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            document.getElementById('alertIcon').textContent = iconMap[type];
            document.getElementById('alertIcon').className = `beautiful-icon ${type}`;
            
            window.closeAlertCallback = resolve;
            document.getElementById('alertDialog').classList.add('active');
        });
    }

    function closeAlert() {
        document.getElementById('alertDialog').classList.remove('active');
        if (window.closeAlertCallback) window.closeAlertCallback();
    }

    // ==================== INITIALIZATION ====================
    function initializeApp() {
        if (appInitialized) return; // Prevent multiple initializations
        appInitialized = true;
        
        console.log('Initializing app...');
        console.log('Members count:', allItems.members ? allItems.members.length : 0);

        // Check if any admins exist
        if (!allItems.members || allItems.members.length === 0) {
            console.log('‚úì NO ADMINS - showing setup form');
            document.getElementById('setupForm').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
        } else {
            console.log('‚úì ADMINS EXIST - showing login form');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('setupForm').style.display = 'none';
        }
    }

    // ==================== MODAL FUNCTIONS ====================
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function openAddItemModal() {
        document.getElementById('addItemModal').classList.add('active');
    }

    // ==================== AUTH FUNCTIONS ====================
    function showSetup() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('setupForm').style.display = 'block';
    }

    function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('setupForm').style.display = 'none';
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        const user = allItems.members && allItems.members.length > 0
            ? allItems.members.find(m => m && m.email === email && m.password === password)
            : null;

        if (!user) {
            await showAlert('‚ùå Login Failed', 'Invalid email or password', 'error');
            return;
        }

        currentUser = user;
        showApp();
    }

    async function handleSetup(e) {
        e.preventDefault();
        const fullName = document.getElementById('setupFullName').value;
        const email = document.getElementById('setupEmail').value;
        const password = document.getElementById('setupPassword').value;
        const confirmPassword = document.getElementById('setupConfirmPassword').value;
        const mobile = document.getElementById('setupMobile').value;
        const designation = document.getElementById('setupDesignation').value;
        const department = document.getElementById('setupDepartment').value;

        if (password !== confirmPassword) {
            await showAlert('‚ùå Error', 'Passwords do not match', 'error');
            return;
        }

        const admin = {
            id: Date.now(),
            fullName,
            email,
            password,
            mobile,
            designation,
            department,
            role: 'admin',
            createdDate: new Date().toISOString()
        };

        if (!allItems.members) allItems.members = [];
        allItems.members.push(admin);
        currentUser = admin;

        window.saveData(allItems);
        await showAlert('‚úÖ Success', 'Admin account created!', 'success');
        location.reload();
    }

    function logout() {
        currentUser = null;
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
    }

    function showApp() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('userDisplay').textContent = currentUser.fullName;
        displayItems();
    }

    // ==================== PAGE NAVIGATION ====================
    function showViewItems() {
        currentPage = 'viewItems';
        document.getElementById('viewItemsPage').style.display = 'block';
        document.getElementById('addItemPage').style.display = 'none';
        document.getElementById('membersPage').style.display = 'none';
        document.getElementById('addMemberPage').style.display = 'none';
        document.getElementById('pageTitle').textContent = 'üì¶ Inventory Items';
        displayItems();
    }

    function showAddItem() {
        currentPage = 'addItem';
        document.getElementById('viewItemsPage').style.display = 'none';
        document.getElementById('addItemPage').style.display = 'block';
        document.getElementById('membersPage').style.display = 'none';
        document.getElementById('addMemberPage').style.display = 'none';
        document.getElementById('pageTitle').textContent = '‚ûï Add Item';
    }

    function showViewMembers() {
        currentPage = 'viewMembers';
        document.getElementById('viewItemsPage').style.display = 'none';
        document.getElementById('addItemPage').style.display = 'none';
        document.getElementById('membersPage').style.display = 'block';
        document.getElementById('addMemberPage').style.display = 'none';
        document.getElementById('pageTitle').textContent = 'üë• Members';
        displayMembers();
    }

    function showAddMember() {
        currentPage = 'addMember';
        document.getElementById('viewItemsPage').style.display = 'none';
        document.getElementById('addItemPage').style.display = 'none';
        document.getElementById('membersPage').style.display = 'none';
        document.getElementById('addMemberPage').style.display = 'block';
        document.getElementById('pageTitle').textContent = 'üë§ Add Member';
    }

    // ==================== DISPLAY FUNCTIONS ====================
    function displayItems() {
        const tbody = document.getElementById('itemsTableBody');
        document.getElementById('itemCount').textContent = allItems.items ? allItems.items.length : 0;

        if (!allItems.items || allItems.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No items found</td></tr>';
            return;
        }

        tbody.innerHTML = allItems.items.map((item, index) => {
            const holder = allItems.members && allItems.members.length > 0
                ? allItems.members.find(m => m && m.id === item.assignedTo)
                : null;

            const conditionClass = item.condition === '‚úì Working' ? 'working' :
                item.condition === '‚úó Not Working' ? 'notworking' : 'na';

            return `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.serialNumber}</td>
                    <td>${holder ? holder.fullName : 'Unassigned'}</td>
                    <td>
                        <span class="condition-badge condition-${conditionClass}">
                            ${item.condition}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-assign" onclick="openAssignModal(${index})">üì§ Assign</button>
                            ${item.assignedTo ? `<button class="btn-notify" onclick="sendNotification(${index})" title="Send notification">üîî</button>` : ''}
                            <button class="btn-small btn-delete" onclick="openDeleteModal(${index})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function displayMembers() {
        const tbody = document.getElementById('membersTableBody');
        document.getElementById('memberCount').textContent = allItems.members ? allItems.members.length : 0;

        if (!allItems.members || allItems.members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No members found</td></tr>';
            return;
        }

        tbody.innerHTML = allItems.members.map((member) => {
            return `
                <tr>
                    <td>${member.fullName}</td>
                    <td>${member.email}</td>
                    <td>${member.mobile || '-'}</td>
                    <td>${member.designation || '-'}</td>
                    <td>${member.department || '-'}</td>
                </tr>
            `;
        }).join('');
    }

    // ==================== ITEM FUNCTIONS ====================
    async function handleAddItem(e) {
        e.preventDefault();
        const name = document.getElementById('itemName').value;
        const serial = document.getElementById('itemSerial').value;
        const condition = document.getElementById('itemCondition').value;

        const item = {
            id: Date.now(),
            name,
            serialNumber: serial,
            condition,
            assignedTo: null,
            createdDate: new Date().toISOString()
        };

        if (!allItems.items) allItems.items = [];
        allItems.items.push(item);

        window.saveData(allItems);

        document.getElementById('itemName').value = '';
        document.getElementById('itemSerial').value = '';
        document.getElementById('itemCondition').value = '';

        document.getElementById('addItemModal').classList.remove('active');
        displayItems();
        await showAlert('‚úÖ Item Added', `${name} has been added successfully!`, 'success');
    }

    async function handleAddItemForm(e) {
        e.preventDefault();
        const name = document.getElementById('formItemName').value;
        const serial = document.getElementById('formItemSerial').value;
        const condition = document.getElementById('formItemCondition').value;

        const item = {
            id: Date.now(),
            name,
            serialNumber: serial,
            condition,
            assignedTo: null,
            createdDate: new Date().toISOString()
        };

        if (!allItems.items) allItems.items = [];
        allItems.items.push(item);

        window.saveData(allItems);

        document.getElementById('formItemName').value = '';
        document.getElementById('formItemSerial').value = '';
        document.getElementById('formItemCondition').value = '';

        showViewItems();
        await showAlert('‚úÖ Item Added', `${name} has been added successfully!`, 'success');
    }

    function openDeleteModal(index) {
        pendingDeleteIndex = index;
        document.getElementById('deleteItemModal').classList.add('active');
    }

    async function confirmDeleteItem() {
        if (pendingDeleteIndex !== null) {
            const itemName = allItems.items[pendingDeleteIndex].name;
            allItems.items.splice(pendingDeleteIndex, 1);
            window.saveData(allItems);
            document.getElementById('deleteItemModal').classList.remove('active');
            displayItems();
            await showAlert('‚úÖ Deleted', `${itemName} has been deleted.`, 'success');
            pendingDeleteIndex = null;
        }
    }

    function openAssignModal(index) {
        pendingAssignIndex = index;
        const select = document.getElementById('assignMember');
        select.innerHTML = '<option value="">Choose member</option>';
        
        allItems.members.forEach((member, idx) => {
            const option = document.createElement('option');
            option.value = idx;
            option.textContent = `${member.fullName} (${member.email})`;
            select.appendChild(option);
        });

        document.getElementById('assignItemModal').classList.add('active');
    }

    async function handleAssignItem(e) {
        e.preventDefault();
        const memberIdx = parseInt(document.getElementById('assignMember').value);

        if (isNaN(memberIdx)) {
            await showAlert('‚ùå Error', 'Please select a member', 'error');
            return;
        }

        allItems.items[pendingAssignIndex].assignedTo = allItems.members[memberIdx].id;
        window.saveData(allItems);
        document.getElementById('assignItemModal').classList.remove('active');
        displayItems();
        await showAlert('‚úÖ Assigned', `Item assigned to ${allItems.members[memberIdx].fullName}`, 'success');
        pendingAssignIndex = null;
    }

    async function sendNotification(index) {
        const item = allItems.items[index];
        const member = allItems.members.find(m => m && m.id === item.assignedTo);

        if (!member) {
            await showAlert('‚ö†Ô∏è Error', 'Member not found', 'error');
            return;
        }

        const confirmed = await showConfirm(
            'üìß Send Notification',
            `Send notification email to ${member.fullName} at ${member.email}?`,
            'info'
        );

        if (confirmed) {
            const notification = {
                type: 'ITEM_ASSIGNMENT',
                recipient: member.email,
                subject: `Item Assigned: ${item.name}`,
                body: `Item "${item.name}" (Serial: ${item.serialNumber}) has been assigned to you.\n\nCondition: ${item.condition}`,
                timestamp: new Date().toISOString(),
                itemId: item.id,
                status: 'pending'
            };

            if (!allItems.emails) allItems.emails = [];
            allItems.emails.push(notification);
            window.saveData(allItems);

            await showAlert('‚úÖ Sent', `Notification email queued for ${member.fullName}`, 'success');
        }
    }

    // ==================== MEMBER FUNCTIONS ====================
    async function handleAddMemberForm(e) {
        e.preventDefault();

        const fullName = document.getElementById('formMemberName').value;
        const email = document.getElementById('formMemberEmail').value;
        const password = document.getElementById('formMemberPassword').value;
        const confirmPassword = document.getElementById('formMemberConfirmPassword').value;
        const mobile = document.getElementById('formMemberMobile').value;
        const designation = document.getElementById('formMemberDesignation').value;
        const department = document.getElementById('formMemberDepartment').value;

        if (password !== confirmPassword) {
            await showAlert('‚ùå Error', 'Passwords do not match', 'error');
            return;
        }

        const member = {
            id: Date.now(),
            fullName,
            email,
            password,
            mobile,
            designation,
            department,
            role: 'member',
            createdDate: new Date().toISOString()
        };

        if (!allItems.members) allItems.members = [];
        allItems.members.push(member);

        window.saveData(allItems);

        const sendEmail = await showConfirm(
            'üìß Send Credentials',
            `Send welcome email with login credentials to ${email}?`,
            'info'
        );

        if (sendEmail) {
            const emailRecord = {
                type: 'WELCOME_EMAIL',
                recipient: email,
                subject: 'Asset Manager Pro - Account Created',
                body: `Dear ${fullName},\n\nYour account has been created successfully.\n\nEmail: ${email}\nPassword: ${password}\n\nPlease change your password after first login.\n\nBest regards,\nAsset Manager Pro`,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            if (!allItems.emails) allItems.emails = [];
            allItems.emails.push(emailRecord);
            window.saveData(allItems);

            await showAlert('‚úÖ Success', `Member added and email sent to ${email}`, 'success');
        } else {
            await showAlert('‚úÖ Success', `Member ${fullName} added without sending email`, 'success');
        }

        document.getElementById('formMemberName').value = '';
        document.getElementById('formMemberEmail').value = '';
        document.getElementById('formMemberPassword').value = '';
        document.getElementById('formMemberConfirmPassword').value = '';
        document.getElementById('formMemberMobile').value = '';
        document.getElementById('formMemberDesignation').value = '';
        document.getElementById('formMemberDepartment').value = '';

        showViewMembers();
    }

    // ==================== EDIT/CHANGE FUNCTIONS ====================
    async function editProfile() {
        await showAlert('üë§ Profile', `Edit profile for ${currentUser.fullName}`, 'info');
    }

    async function changePassword() {
        await showAlert('üîê Password', 'Change password feature coming soon', 'info');
    }

    // ==================== START WAITING FOR LOADER ====================
    // Start waiting immediately, don't wait for DOMContentLoaded
    waitForLoaderData();

    window.onclick = function (event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('active');
        }
    };
</script>

</body>
</html>