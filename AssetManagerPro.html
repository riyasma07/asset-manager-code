<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Manager Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        /* ==================== AUTH SCREEN ==================== */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .auth-header h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .auth-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #374151;
            font-weight: 600;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-auth {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s;
        }

        .btn-auth:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .auth-footer {
            text-align: center;
            margin-top: 15px;
            color: #6b7280;
            font-size: 13px;
        }

        .auth-footer a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        /* ==================== MAIN APP ==================== */
        .app-container {
            display: none;
            min-height: 100vh;
            background: white;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-logout {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .app-content {
            display: flex;
        }

        .sidebar {
            width: 220px;
            background: #f9fafb;
            border-right: 1px solid #e5e7eb;
            padding: 20px;
            min-height: calc(100vh - 70px);
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-title {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .menu-item {
            padding: 10px 12px;
            color: #374151;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background: #e5e7eb;
        }

        .menu-item.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .main {
            flex: 1;
            padding: 40px;
        }

        .main-title {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .button-group {
            margin-bottom: 20px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        /* ==================== ITEMS TABLE ==================== */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .items-table thead {
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }

        .items-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }

        .items-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            font-size: 14px;
        }

        .items-table tr:hover {
            background: #f9fafb;
        }

        /* ==================== CONDITION BADGE ==================== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.working {
            background: #dcfce7;
            color: #166534;
        }

        .badge.notworking {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.na {
            background: #fed7aa;
            color: #b45309;
        }

        /* ==================== ACTION BUTTONS ==================== */
        .btn-small {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }

        .btn-assign {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-notify {
            background: #3b82f6;
            color: white;
        }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: #e5e7eb;
            color: #374151;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-confirm {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ==================== DIALOG ==================== */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.active {
            display: flex;
        }

        .dialog {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .dialog-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .dialog-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .dialog-message {
            color: #6b7280;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .app-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                min-height: auto;
                padding: 15px;
            }

            .main {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authContainer" class="auth-container">
    <!-- LOGIN FORM -->
    <div id="loginForm" class="auth-box" style="display: none;">
        <div class="auth-header">
            <div class="auth-icon">üîê</div>
            <h1>Asset Manager Pro</h1>
            <p>Professional Inventory System</p>
        </div>

        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" required>
            </div>

            <button type="submit" class="btn-auth">üîì Sign In</button>
        </form>

        <div class="auth-footer">
            New user? Ask your admin to add you.
        </div>
    </div>

    <!-- SETUP FORM -->
    <div id="setupForm" class="auth-box" style="display: none;">
        <div class="auth-header">
            <div class="auth-icon">üîß</div>
            <h1>First Time Setup</h1>
            <p>You will be the admin</p>
        </div>

        <form onsubmit="handleSetup(event)">
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="setupFullName" placeholder="Your name" required>
            </div>

            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="setupEmail" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
                <label>Mobile</label>
                <input type="tel" id="setupMobile" placeholder="Phone number">
            </div>

            <div class="form-group">
                <label>Designation</label>
                <input type="text" id="setupDesignation" placeholder="Your designation">
            </div>

            <div class="form-group">
                <label>Department</label>
                <input type="text" id="setupDepartment" placeholder="Your department">
            </div>

            <div class="form-group">
                <label>Password * (Min 6)</label>
                <input type="password" id="setupPassword" placeholder="Min 6 characters" required minlength="6">
            </div>

            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="password" id="setupConfirmPassword" placeholder="Confirm password" required>
            </div>

            <button type="submit" class="btn-auth">üëë Create Admin Account</button>
        </form>

        <div class="auth-footer">
            Already registered? <a onclick="showLogin()">Sign In</a>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="app-container">
    <div class="app-header">
        <h1 id="pageTitle">üì¶ Inventory Items</h1>
        <div class="user-info">
            <span id="userName">User</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app-content">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="menu-section">
                <div class="menu-title">üìã Menu</div>
                <div class="menu-item active" onclick="showPage('items')">View Items</div>
                <div class="menu-item" onclick="showPage('addItem')">Add Item</div>
                <div class="menu-item" onclick="showPage('members')">View Members</div>
                <div class="menu-item" onclick="showPage('addMember')">Add Member</div>
            </div>

            <div class="menu-section">
                <div class="menu-title">‚öôÔ∏è Settings</div>
                <div class="menu-item" onclick="editProfile()">Edit Profile</div>
                <div class="menu-item" onclick="changePassword()">Change Password</div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            <!-- ITEMS PAGE -->
            <div id="itemsPage">
                <div class="main-title">üì¶ Inventory Items</div>
                <div class="button-group">
                    <button class="btn-primary" onclick="openModal('addItemModal')">‚ûï Add Item</button>
                </div>
                <p style="margin-bottom: 15px; color: #6b7280;">Total Items: <strong id="itemCount">0</strong></p>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Serial Number</th>
                            <th>Holder</th>
                            <th>Condition</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #9ca3af;">No items found</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ADD ITEM PAGE -->
            <div id="addItemPage" style="display: none;">
                <div class="main-title">‚ûï Add Item</div>
                <form onsubmit="handleAddItem(event)" style="max-width: 500px;">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" id="addItemName" required>
                    </div>
                    <div class="form-group">
                        <label>Serial Number *</label>
                        <input type="text" id="addItemSerial" required>
                    </div>
                    <div class="form-group">
                        <label>Condition *</label>
                        <select id="addItemCondition" required>
                            <option value="">Select Condition</option>
                            <option value="‚úì Working">‚úì Working</option>
                            <option value="‚úó Not Working">‚úó Not Working</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>
                    <div style="margin-top: 20px;">
                        <button type="button" class="btn-cancel" onclick="showPage('items')">Cancel</button>
                        <button type="submit" class="btn-confirm" style="margin-left: 10px;">Add Item</button>
                    </div>
                </form>
            </div>

            <!-- MEMBERS PAGE -->
            <div id="membersPage" style="display: none;">
                <div class="main-title">üë• Members</div>
                <div class="button-group">
                    <button class="btn-primary" onclick="showPage('addMember')">üë§ Add Member</button>
                </div>
                <p style="margin-bottom: 15px; color: #6b7280;">Total Members: <strong id="memberCount">0</strong></p>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>Designation</th>
                            <th>Department</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #9ca3af;">No members found</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ADD MEMBER PAGE -->
            <div id="addMemberPage" style="display: none;">
                <div class="main-title">üë§ Add Member</div>
                <form onsubmit="handleAddMember(event)" style="max-width: 500px;">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="addMemberName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="addMemberEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Mobile</label>
                        <input type="tel" id="addMemberMobile">
                    </div>
                    <div class="form-group">
                        <label>Designation</label>
                        <input type="text" id="addMemberDesignation">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="addMemberDepartment">
                    </div>
                    <div class="form-group">
                        <label>Password * (Min 6)</label>
                        <input type="password" id="addMemberPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" id="addMemberConfirmPassword" required>
                    </div>
                    <div style="margin-top: 20px;">
                        <button type="button" class="btn-cancel" onclick="showPage('members')">Cancel</button>
                        <button type="submit" class="btn-confirm" style="margin-left: 10px;">Add Member</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ADD ITEM MODAL -->
<div id="addItemModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2>‚ûï Add Item</h2>
            <button class="modal-close" onclick="closeModal('addItemModal')">√ó</button>
        </div>
        <form onsubmit="handleAddItemModal(event)">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="modalItemName" required>
            </div>
            <div class="form-group">
                <label>Serial Number *</label>
                <input type="text" id="modalItemSerial" required>
            </div>
            <div class="form-group">
                <label>Condition *</label>
                <select id="modalItemCondition" required>
                    <option value="">Select Condition</option>
                    <option value="‚úì Working">‚úì Working</option>
                    <option value="‚úó Not Working">‚úó Not Working</option>
                    <option value="N/A">N/A</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('addItemModal')">Cancel</button>
                <button type="submit" class="btn-confirm">Add Item</button>
            </div>
        </form>
    </div>
</div>

<!-- ASSIGN ITEM MODAL -->
<div id="assignItemModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2>üì§ Assign Item</h2>
            <button class="modal-close" onclick="closeModal('assignItemModal')">√ó</button>
        </div>
        <form onsubmit="handleAssignItem(event)">
            <div class="form-group">
                <label>Select Member *</label>
                <select id="assignMemberSelect" required>
                    <option value="">Choose member</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('assignItemModal')">Cancel</button>
                <button type="submit" class="btn-confirm">Assign</button>
            </div>
        </form>
    </div>
</div>

<!-- DELETE ITEM MODAL -->
<div id="deleteItemModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2>üóëÔ∏è Delete Item</h2>
            <button class="modal-close" onclick="closeModal('deleteItemModal')">√ó</button>
        </div>
        <p style="margin: 20px 0; color: #6b7280;">This action cannot be undone. Are you sure?</p>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal('deleteItemModal')">Cancel</button>
            <button type="button" class="btn-confirm" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<!-- NOTIFICATION MODAL -->
<div id="notificationModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2>üìß Send Notification</h2>
            <button class="modal-close" onclick="closeModal('notificationModal')">√ó</button>
        </div>
        <p id="notificationMessage" style="margin: 20px 0; color: #6b7280;"></p>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal('notificationModal')">Cancel</button>
            <button type="button" class="btn-confirm" onclick="confirmNotification()">Send</button>
        </div>
    </div>
</div>

<!-- ALERT DIALOG -->
<div id="alertDialog" class="dialog-overlay">
    <div class="dialog">
        <div class="dialog-icon" id="alertIcon"></div>
        <div class="dialog-title" id="alertTitle"></div>
        <div class="dialog-message" id="alertMessage"></div>
        <div class="dialog-buttons">
            <button class="btn-confirm" onclick="closeAlert()">OK</button>
        </div>
    </div>
</div>

<script>
    let allItems = { items: [], members: [], emails: [] };
    let currentUser = null;
    let appInitialized = false;
    let pendingDeleteIndex = null;
    let pendingAssignIndex = null;
    let pendingNotifyIndex = null;

    // ==================== WAIT FOR LOADER DATA ====================
    function waitForData() {
        if (typeof window.assetManagerData !== 'undefined' && window.assetManagerData) {
            allItems = window.assetManagerData;
            console.log('‚úì Data loaded:', allItems);
            initializeApp();
        } else if (!appInitialized) {
            setTimeout(waitForData, 300);
        }
    }

    // ==================== INITIALIZE ==================== 
    function initializeApp() {
        if (appInitialized) return;
        appInitialized = true;

        console.log('Initializing app. Members:', allItems.members ? allItems.members.length : 0);

        if (!allItems.members || allItems.members.length === 0) {
            console.log('‚úì No admins - showing setup');
            document.getElementById('setupForm').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
        } else {
            console.log('‚úì Admins exist - showing login');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('setupForm').style.display = 'none';
        }
    }

    // ==================== AUTH ==================== 
    function showLogin() {
        document.getElementById('setupForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        const user = allItems.members && allItems.members.find(m => m && m.email === email && m.password === password);

        if (!user) {
            await showAlert('‚ùå Login Failed', 'Invalid email or password', 'error');
            return;
        }

        currentUser = user;
        showApp();
    }

    async function handleSetup(e) {
        e.preventDefault();
        const admin = {
            id: Date.now(),
            fullName: document.getElementById('setupFullName').value,
            email: document.getElementById('setupEmail').value,
            password: document.getElementById('setupPassword').value,
            mobile: document.getElementById('setupMobile').value,
            designation: document.getElementById('setupDesignation').value,
            department: document.getElementById('setupDepartment').value,
            role: 'admin',
            createdDate: new Date().toISOString()
        };

        if (admin.password !== document.getElementById('setupConfirmPassword').value) {
            await showAlert('‚ùå Error', 'Passwords do not match', 'error');
            return;
        }

        if (!allItems.members) allItems.members = [];
        allItems.members.push(admin);
        currentUser = admin;

        window.saveData(allItems);
        await showAlert('‚úÖ Success', 'Admin created!', 'success');
        location.reload();
    }

    function logout() {
        currentUser = null;
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
    }

    function showApp() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userName').textContent = currentUser.fullName;
        displayItems();
    }

    // ==================== PAGE NAVIGATION ==================== 
    function showPage(page) {
        document.getElementById('itemsPage').style.display = 'none';
        document.getElementById('addItemPage').style.display = 'none';
        document.getElementById('membersPage').style.display = 'none';
        document.getElementById('addMemberPage').style.display = 'none';

        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => item.classList.remove('active'));

        switch(page) {
            case 'items':
                document.getElementById('itemsPage').style.display = 'block';
                document.getElementById('pageTitle').textContent = 'üì¶ Inventory Items';
                displayItems();
                break;
            case 'addItem':
                document.getElementById('addItemPage').style.display = 'block';
                document.getElementById('pageTitle').textContent = '‚ûï Add Item';
                break;
            case 'members':
                document.getElementById('membersPage').style.display = 'block';
                document.getElementById('pageTitle').textContent = 'üë• Members';
                displayMembers();
                break;
            case 'addMember':
                document.getElementById('addMemberPage').style.display = 'block';
                document.getElementById('pageTitle').textContent = 'üë§ Add Member';
                break;
        }
    }

    // ==================== DISPLAY ==================== 
    function displayItems() {
        const tbody = document.getElementById('itemsTableBody');
        document.getElementById('itemCount').textContent = allItems.items ? allItems.items.length : 0;

        if (!allItems.items || allItems.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No items found</td></tr>';
            return;
        }

        tbody.innerHTML = allItems.items.map((item, idx) => {
            const holder = allItems.members && allItems.members.find(m => m && m.id === item.assignedTo);
            const badgeClass = item.condition.includes('Working') ? 'working' : item.condition.includes('Not') ? 'notworking' : 'na';

            return `<tr>
                <td>${item.name}</td>
                <td>${item.serialNumber}</td>
                <td>${holder ? holder.fullName : 'Unassigned'}</td>
                <td><span class="badge ${badgeClass}">${item.condition}</span></td>
                <td>
                    <button class="btn-small btn-assign" onclick="openAssign(${idx})">üì§ Assign</button>
                    ${item.assignedTo ? `<button class="btn-small btn-notify" onclick="openNotify(${idx})">üîî</button>` : ''}
                    <button class="btn-small btn-delete" onclick="openDelete(${idx})">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    function displayMembers() {
        const tbody = document.getElementById('membersTableBody');
        document.getElementById('memberCount').textContent = allItems.members ? allItems.members.length : 0;

        if (!allItems.members || allItems.members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No members found</td></tr>';
            return;
        }

        tbody.innerHTML = allItems.members.map(m => `<tr>
            <td>${m.fullName}</td>
            <td>${m.email}</td>
            <td>${m.mobile || '-'}</td>
            <td>${m.designation || '-'}</td>
            <td>${m.department || '-'}</td>
        </tr>`).join('');
    }

    // ==================== ITEMS ==================== 
    async function handleAddItem(e) {
        e.preventDefault();
        const item = {
            id: Date.now(),
            name: document.getElementById('addItemName').value,
            serialNumber: document.getElementById('addItemSerial').value,
            condition: document.getElementById('addItemCondition').value,
            assignedTo: null,
            createdDate: new Date().toISOString()
        };

        if (!allItems.items) allItems.items = [];
        allItems.items.push(item);
        window.saveData(allItems);

        document.getElementById('addItemName').value = '';
        document.getElementById('addItemSerial').value = '';
        document.getElementById('addItemCondition').value = '';

        showPage('items');
        await showAlert('‚úÖ Success', 'Item added!', 'success');
    }

    async function handleAddItemModal(e) {
        e.preventDefault();
        const item = {
            id: Date.now(),
            name: document.getElementById('modalItemName').value,
            serialNumber: document.getElementById('modalItemSerial').value,
            condition: document.getElementById('modalItemCondition').value,
            assignedTo: null,
            createdDate: new Date().toISOString()
        };

        if (!allItems.items) allItems.items = [];
        allItems.items.push(item);
        window.saveData(allItems);

        closeModal('addItemModal');
        displayItems();
        await showAlert('‚úÖ Success', 'Item added!', 'success');
    }

    function openAssign(idx) {
        pendingAssignIndex = idx;
        const select = document.getElementById('assignMemberSelect');
        select.innerHTML = '<option value="">Choose member</option>';
        allItems.members.forEach((m, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = `${m.fullName} (${m.email})`;
            select.appendChild(opt);
        });
        openModal('assignItemModal');
    }

    async function handleAssignItem(e) {
        e.preventDefault();
        const memberIdx = parseInt(document.getElementById('assignMemberSelect').value);
        if (isNaN(memberIdx)) {
            await showAlert('‚ùå Error', 'Select a member', 'error');
            return;
        }

        allItems.items[pendingAssignIndex].assignedTo = allItems.members[memberIdx].id;
        window.saveData(allItems);
        closeModal('assignItemModal');
        displayItems();
        await showAlert('‚úÖ Assigned', 'Item assigned!', 'success');
    }

    function openDelete(idx) {
        pendingDeleteIndex = idx;
        openModal('deleteItemModal');
    }

    async function confirmDelete() {
        if (pendingDeleteIndex !== null) {
            allItems.items.splice(pendingDeleteIndex, 1);
            window.saveData(allItems);
            closeModal('deleteItemModal');
            displayItems();
            await showAlert('‚úÖ Deleted', 'Item deleted!', 'success');
        }
    }

    function openNotify(idx) {
        pendingNotifyIndex = idx;
        const item = allItems.items[idx];
        const member = allItems.members.find(m => m && m.id === item.assignedTo);
        document.getElementById('notificationMessage').textContent = `Send notification to ${member.fullName} at ${member.email}?`;
        openModal('notificationModal');
    }

    async function confirmNotification() {
        const item = allItems.items[pendingNotifyIndex];
        const member = allItems.members.find(m => m && m.id === item.assignedTo);

        const notification = {
            type: 'ITEM_ASSIGNMENT',
            recipient: member.email,
            subject: `Item Assigned: ${item.name}`,
            body: `Item "${item.name}" assigned. Condition: ${item.condition}`,
            timestamp: new Date().toISOString(),
            status: 'pending'
        };

        if (!allItems.emails) allItems.emails = [];
        allItems.emails.push(notification);
        window.saveData(allItems);

        closeModal('notificationModal');
        await showAlert('‚úÖ Sent', 'Notification queued!', 'success');
    }

    // ==================== MEMBERS ==================== 
    async function handleAddMember(e) {
        e.preventDefault();
        const password = document.getElementById('addMemberPassword').value;
        const confirm = document.getElementById('addMemberConfirmPassword').value;

        if (password !== confirm) {
            await showAlert('‚ùå Error', 'Passwords do not match', 'error');
            return;
        }

        const member = {
            id: Date.now(),
            fullName: document.getElementById('addMemberName').value,
            email: document.getElementById('addMemberEmail').value,
            password,
            mobile: document.getElementById('addMemberMobile').value,
            designation: document.getElementById('addMemberDesignation').value,
            department: document.getElementById('addMemberDepartment').value,
            role: 'member',
            createdDate: new Date().toISOString()
        };

        if (!allItems.members) allItems.members = [];
        allItems.members.push(member);
        window.saveData(allItems);

        const sendEmail = await confirmDialog('üìß Send Email?', `Send credentials to ${member.email}?`);

        if (sendEmail) {
            const email = {
                type: 'WELCOME_EMAIL',
                recipient: member.email,
                subject: 'Asset Manager Pro - Account Created',
                body: `Email: ${member.email}\nPassword: ${password}`,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            if (!allItems.emails) allItems.emails = [];
            allItems.emails.push(email);
            window.saveData(allItems);

            await showAlert('‚úÖ Success', 'Member added & email sent!', 'success');
        } else {
            await showAlert('‚úÖ Success', 'Member added!', 'success');
        }

        document.getElementById('addMemberName').value = '';
        document.getElementById('addMemberEmail').value = '';
        document.getElementById('addMemberPassword').value = '';
        document.getElementById('addMemberConfirmPassword').value = '';
        document.getElementById('addMemberMobile').value = '';
        document.getElementById('addMemberDesignation').value = '';
        document.getElementById('addMemberDepartment').value = '';

        showPage('members');
    }

    async function editProfile() {
        await showAlert('üë§ Profile', `Edit ${currentUser.fullName}'s profile`, 'info');
    }

    async function changePassword() {
        await showAlert('üîê Password', 'Feature coming soon', 'info');
    }

    // ==================== MODAL ==================== 
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // ==================== DIALOGS ==================== 
    async function showAlert(title, message, type) {
        return new Promise(resolve => {
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            document.getElementById('alertIcon').textContent = icons[type] || '‚Ñπ';
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            window.alertCallback = resolve;
            document.getElementById('alertDialog').classList.add('active');
        });
    }

    function closeAlert() {
        document.getElementById('alertDialog').classList.remove('active');
        if (window.alertCallback) window.alertCallback();
    }

    async function confirmDialog(title, message) {
        return new Promise(resolve => {
            document.getElementById('alertIcon').textContent = '‚ùì';
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            window.alertCallback = resolve;
            document.getElementById('alertDialog').classList.add('active');
        });
    }

    // ==================== STARTUP ==================== 
    waitForData();

    window.onclick = e => {
        if (e.target.classList.contains('modal-overlay')) {
            e.target.classList.remove('active');
        }
    };
</script>

</body>
</html>